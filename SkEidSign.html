<!DOCTYPE html><html lang=sk><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=X-Xss-Protection content="1; mode=block"><meta http-equiv=X-Content-Type-Options content=nosniff><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="RSS Feed" href=/feed.rss><link rel=alternate type=application/atom+xml title="Atom Feed" href=/feed.atom><meta name=author content=harrison314><title>Podpísanie PDF-ka Slovenským eID-čkom</title><meta property=og:title content="Podpísanie PDF-ka Slovenským eID-čkom"><meta property=og:description content="Článok o elektronickom podpisovaní PDF SLovenským eID v .Net Core."><meta property=og:url content=https://harrison314.github.io/SkEidSign.html><meta property=og:image content=https://harrison314.github.io/images/Programing/SkEidSign/eid_200.jpg><meta name=description content="Článok o elektronickom podpisovaní PDF SLovenským eID v .Net Core."><link href=css/bootstrap.min.css rel=stylesheet><link href=css/blog-post.css rel=stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><style>img{max-width:100%}.img-center{display:block;margin-left:auto;margin-right:auto}</style><body><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=index.html>harrison314 blog</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href=/All.html>Obsah</a><li><a href=/DevelopingAll.html>Programovanie</a><li><a href=/GeneralAll.html>Všeobecné</a><li><a href=/OMne.html>O mne</a></ul></div></div></nav><div class=container><div class=row><div class="col-lg-8 col-md-8"><h1>Podpísanie PDF-ka Slovenským eID-čkom</h1><div class=publishDate>Júl 2018</div><p>V tomto článku sa pokúsim v&nbsp;skratke vysvetliť princípy podpisovania dokumentov pomocou <em>PKCS#11</em> a&nbsp;ukážem to a&nbsp;Slovenskom eID-čku, pomocou jednoduchej konzolovej aplikácii v&nbsp;.Net Core.<p><strong>Disclaimer</strong>: Podpisová aplikácia má slúžiť len na&nbsp;ukážku princípov, nevytvára validné podpisy podľa Európskej legislatívy (<em>eIDAS PAdES</em>), aj&nbsp;keď mnohé známe firmy posielajú faktúry podpísané rovnakým spôsobom. Použitie len na&nbsp;vlastné riziko!<p>Zdrojové kódy ukážkovej aplikácie sa nachádzajú na&nbsp;<a href=https://github.com/harrison314/SlovakEidSignTool>https://github.com/harrison314/SlovakEidSignTool</a>.<h2 id=pkcs11>PKCS#11</h2><p><em>PKCS#11</em> je štandard definujúci C-éčkove API pre&nbsp;komunikáciu z&nbsp;crypto tokenmi ako sú HSM (<em>Hardware security module</em>), tokeny a&nbsp;čipové karty (<em>smart cards</em>). Práve Slovenské eID-čko je takáto čipová karta.<p>Na obrázku nižšie sa nachádza HSM-ko a&nbsp;slovenské eID.<p><img src=images/Programing/SkEidSign/hsm_200.jpg alt="HSM (Hardware security module)"> <img src=images/Programing/SkEidSign/eid_200.jpg alt="Slovenské eID"><p>V projekte využívam knižnicu PKCS#11-interop, ktorá tvorí manažovaný wrapper, nad C-čkovým API.<h2 id=proces-podpisania-dokumentu>Proces podpísania dokumentu</h2><p>Na začiatku sa načíta a&nbsp;inicializuje <em>PKCS#11</em> knižnica pre&nbsp;eID, ktorá je súčasťou aplikácie <a href=https://www.slovensko.sk/sk/na-stiahnutie>eID klient</a>.<p>Vyberie sa slot a&nbsp;token, v&nbsp;tomto prípade je slot čítačka kariet a&nbsp;token samotná čipová karta, eID-čko má slot zo&nbsp;ZEP certifikátom označený labelom <em>SIG_ZEP</em>, program ho vyberie.<p>Načítajú sa informácie o&nbsp;tokene a&nbsp;zistí sa, či&nbsp;je preň potrebná autentifikácia. Pre&nbsp;eID-čko je to BOK PIN, ktorý&nbsp;umožní prístup k&nbsp;objektom na&nbsp;karte.<p>Objekty sú napríklad certifikáty, kľúče, dáta, HW features,… Každý objekt je reprezentovaný definovanou množinou atribútov. Knižnice implementujúce štandard PKCS#11 izolujú operácie pomocou sessions (operácie v&nbsp;rámci jednej otvorenej session nemajú garantované thread-safe spávanie), jeho zvláštnosťou je, že&nbsp;keď je autentifikovaná jedna session, tak sú autentifikované všetky v&nbsp;aplikácii.<p>Vytvorí sa nová session, ktorá je už autentifikovaná, a&nbsp;vyhľadajú sa všetky certifikáty na&nbsp;tokene. Vyextrahuje sa certifikát v&nbsp;binárnej podobe (atribút <em>CKA_VALUE</em>) a&nbsp;v C# kóde sa zistí, ktorý&nbsp;z certifikátov je určený na&nbsp;podpis dokumentov (certifikát má extension s&nbsp;flagom <em>NonRepudiation</em>). Následne sa k&nbsp;nemu vyhľadá privátny kľuč, ten má spravidla rovnaké atribúty <em>CKA_ID</em> a&nbsp;<em>CKA_LABEL</em> ako príslušný certifikát. Na&nbsp;eID-čku sa dá ZEP/KEP privátny kľúč a&nbsp;certifikát nájsť aj&nbsp;podľa špecifického labelu, ale&nbsp;na to som sa v&nbsp;aplikácii nechcel spoliehať.<p>Podpísanie PDF-ka má a&nbsp;starosti knižnica <a href="https://www.nuget.org/packages/itext7/">iTextSharp</a>, program implementuje rozhranie <a href=https://github.com/harrison314/SlovakEidSignTool/blob/master/src/SlovakEidSignTool/Pdf/Pkcs11ExternalSignature.cs>IExternalSignature</a>, v&nbsp;ktorom prebieha samotné podpísanie PDF-dokumentu. Na&nbsp;vstup dostane dáta z&nbsp;PDF-ka, z&nbsp;ktorých sa vytvorí SHA-256 hash. Z&nbsp;neho sa vytvorí <em>PKCS#1 digest info</em> (<em>ASN.1</em> dátová štruktúra, ktorá je vhodná na&nbsp;podpísanie RSA kľúčom).<p>Samotný podpis musí byť v&nbsp;prípade eID-čka autentifikovaný ZEP PIN-om, ten sa zadáva po&nbsp;inicializácii podpisovania. Čip v&nbsp;eID-čku podpíše hash a&nbsp;vráti podpis. Ten vráti v&nbsp;metóde rozhrania <a href=https://github.com/harrison314/SlovakEidSignTool/blob/master/src/SlovakEidSignTool/Pdf/Pkcs11ExternalSignature.cs>IExternalSignature</a> a&nbsp;<em>iTextSharp</em> dokončí podpisovanie a&nbsp;uloží PDF-ko na&nbsp;disk.<h2 id=zaver>Záver</h2><p>Princíp realizácie podpisu pomocou slovenského eID je podobný ako podpisovanie inými krypto zariadeniami, ku&nbsp;ktorým sa pristupuje pomocou štandardu <em>PKCS#11</em>.<p>Ukážkový program využíva knižnice <a href="https://pkcs11interop.net/">PKCS#11 interop</a> na&nbsp;interakciu z&nbsp;<em>PKCS#11</em> knižnicou, <a href="https://www.nuget.org/packages/itext7/">iTextSharp</a> pre&nbsp;manipuláciu s&nbsp;PDF dokumentom a&nbsp;<a href=https://github.com/commandlineparser/commandline>CommandLine</a> pre&nbsp;parsovanie CLI parametrov.<p>Vytvorenie "surového" RSA alebo&nbsp;EC podpisu je ľahké, ťažšie je to robiť dobre (ochrana PIN-ov, certifikácia softvéru pre&nbsp;podpis od&nbsp;NBU, splnenie špecifikácie pre&nbsp;konkrétne druhy podpisov). Takto podpísané PDF-ko je v&nbsp;Adobre Readery zelené.<p><img src=images/Programing/SkEidSign/SignedDocument.png class=img-center alt="Signed PDF"><p>No podpis nie je platným <em>eIDAS PAdES</em> podpisom, chýbajú mu rôzne atribúty, odkaz na&nbsp;podpisovú politiku,…<h2 id=zdroje>Zdroje</h2><ol><li><a href="https://pkcs11interop.net/">PKCS#11 Interop</a><li><a href=https://github.com/Pkcs11Interop/Pkcs11Interop.X509Store/blob/master/src/Pkcs11Interop.X509Store/Pkcs11X509Certificate.cs>PKCS#11 X509Store</a><li><a href="https://rahulpnath.com/blog/signing-a-pdf-file-using-azure-key-vault/">Signing a&nbsp;PDF File Using Azure Key Vault</a><li><a href=https://www.slovensko.sk/sk/na-stiahnutie>Slovensko.sk</a></ol></div><div class="col-lg-4 col-md-4 hidden-xs hidden-sm"><div class=well><h4>Vývoj</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/BinaryContentInApi.html>ASP.NET Core API a binárny obsah</a><li><a href=/PerformaceInNet.html>Meranie performace pre dotnetistov</a><li><a href=/CngApiTips.html>Triky s Windows CNG API</a><li><a href=/InMemoryOltp.html>Experiment s In-Memory OLTP</a><li><a href=/CoMaNauciloIot.html>Čo ma naučilo IoT</a><li><a href=/SkEid.html>eID nie je platobná karta</a><li><a href=/eVolby.html>Elektronické voľby</a><li><a href=/Blazor.html>Ako ma zachránil Blazor</a><li><a href=/NetCoreSecuring.html>Dodatočné zabezpečenie .Net Core</a><li><a href=/SlovakWyamTypography.html>Slovenská typografia pre wyam</a><li><a href=/DevelopingAll.html>…</a></ul></div></div></div><div class=well><h4>Všeobecné</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/EzoGenerator.html>Generátor Ezo textov</a><li><a href=/AlternativnyRecept.html>Propagácia alternatívnej medicíny</a><li><a href=/VotrelciDavnoveku.html>Votrelci dávnoveku</a><li><a href=/GeneralAll.html>…</a></ul></div></div></div><div class=well><h4>O mne</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/OMne.html>O mne</a><li><a href=/OMneOdkazy.html>Moja tvorba inde</a><li><a href=/Portfolio.html>Portólio</a></ul></div></div></div></div></div><hr><footer><div class=row><div class="col-lg-8 col-sm-8"><div class=well><h4>Našli ste chybu, alebo chcete niečo doplniť?</h4><p>Ak ste našli chybu v článu, chcete niečo dopniť, alebo sa vyjadriť k téme, môžete na <a href="https://github.com/harrison314/harrison314.github.io/issues/new?title=Podp%C3%ADsanie%20PDF-ka%20Slovensk%C3%BDm%20eID-%C4%8Dkom&amp;body=https%3A%2F%2Fharrison314.github.io%2FSkEidSign.html" target=_blank>Githube otvoriť issue</a>.</div></div></div><div class=row><div class=col-lg-12><p>Copyright © harrison314 2013</div></div></footer></div><script src=js/jquery.js></script><script src=js/bootstrap.min.js></script>