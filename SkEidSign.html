<!DOCTYPE html><html lang=sk><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=X-Xss-Protection content="1; mode=block"><meta http-equiv=X-Content-Type-Options content=nosniff><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="RSS Feed" href=feed.rss><meta name=author content=harrison314><meta name=generator content=AspNetStatic><title>Podp&#xED;sanie PDF-ka Slovensk&#xFD;m eID-&#x10D;kom</title><meta property=og:title content="Podpísanie PDF-ka Slovenským eID-čkom"><meta property=og:description content="Článok o elektronickom podpisovaní PDF SLovenským eID v .Net Core."><meta property=og:url content=https://harrison314.github.io/SkEidSign.html><meta property=og:image content=https://harrison314.github.io/images/Programing/SkEidSign/eid_200.jpg><meta name=description content="Článok o elektronickom podpisovaní PDF SLovenským eID v .Net Core."><link href=css/bootstrap.min.css rel=stylesheet><link href=css/blog-post.css rel=stylesheet><script type=text/x-mathjax-config>
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script><script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><link rel=stylesheet href=css/Highiler/vs.css><style>img{max-width:100%}.img-center{display:block;margin-left:auto;margin-right:auto}</style><body><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href=index.html>harrison314 blog</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href=/All.html>Obsah</a><li><a href=/DevelopingAll.html>Programovanie</a><li><a href=/GeneralAll.html>Všeobecné</a><li><a href=/OMne.html>O mne</a></ul></div></div></nav><div class=container><div class=row><div class="col-lg-8 col-md-8"><h1>Podp&#xED;sanie PDF-ka Slovensk&#xFD;m eID-&#x10D;kom</h1><div class=publishDate>J&#xFA;l 2018</div><p>V tomto článku sa pokúsim v&#160;skratke vysvetliť princípy podpisovania dokumentov pomocou <em>PKCS#11</em> a&#160;ukážem to a&#160;Slovenskom eID-čku, pomocou jednoduchej konzolovej aplikácii v&#160;.Net Core.<p><strong>Disclaimer</strong>: Podpisová aplikácia má slúžiť len na&#160;ukážku princípov, nevytvára validné podpisy podľa Európskej legislatívy (<em>eIDAS PAdES</em>), aj&#160;keď mnohé známe firmy posielajú faktúry podpísané rovnakým spôsobom. Použitie len na&#160;vlastné riziko!<p>Zdrojové kódy ukážkovej aplikácie sa nachádzajú na&#160;<a href=https://github.com/harrison314/SlovakEidSignTool>https://github.com/harrison314/SlovakEidSignTool</a>.<h2 id=pkcs11>PKCS#11</h2><p><em>PKCS#11</em> je štandard definujúci C-éčkove API pre&#160;komunikáciu z&#160;crypto tokenmi ako sú HSM (<em>Hardware security module</em>), tokeny a&#160;čipové karty (<em>smart cards</em>). Práve Slovenské eID-čko je takáto čipová karta.<p>Na obrázku nižšie sa nachádza HSM-ko a&#160;slovenské eID.<p><img src=images/Programing/SkEidSign/hsm_200.jpg alt="HSM (Hardware security module)"> <img src=images/Programing/SkEidSign/eid_200.jpg alt="Slovenské eID"><p>V projekte využívam knižnicu PKCS#11-interop, ktorá tvorí manažovaný wrapper, nad C-čkovým API.<h2 id=proces-podpisania-dokumentu>Proces podpísania dokumentu</h2><p>Na začiatku sa načíta a&#160;inicializuje <em>PKCS#11</em> knižnica pre&#160;eID, ktorá je súčasťou aplikácie <a href=https://www.slovensko.sk/sk/na-stiahnutie>eID klient</a>.<p>Vyberie sa slot a&#160;token, v&#160;tomto prípade je slot čítačka kariet a&#160;token samotná čipová karta, eID-čko má slot zo&#160;ZEP certifikátom označený labelom <em>SIG_ZEP</em>, program ho vyberie.<p>Načítajú sa informácie o&#160;tokene a&#160;zistí sa, či&#160;je preň potrebná autentifikácia. Pre&#160;eID-čko je to BOK PIN, ktorý&#160;umožní prístup k&#160;objektom na&#160;karte.<p>Objekty sú napríklad certifikáty, kľúče, dáta, HW features,&#8230; Každý objekt je reprezentovaný definovanou množinou atribútov. Knižnice implementujúce štandard PKCS#11 izolujú operácie pomocou sessions (operácie v&#160;rámci jednej otvorenej session nemajú garantované thread-safe spávanie), jeho zvláštnosťou je, že&#160;keď je autentifikovaná jedna session, tak sú autentifikované všetky v&#160;aplikácii.<p>Vytvorí sa nová session, ktorá je už autentifikovaná, a&#160;vyhľadajú sa všetky certifikáty na&#160;tokene. Vyextrahuje sa certifikát v&#160;binárnej podobe (atribút <em>CKA_VALUE</em>) a&#160;v C# kóde sa zistí, ktorý&#160;z certifikátov je určený na&#160;podpis dokumentov (certifikát má extension s&#160;flagom <em>NonRepudiation</em>). Následne sa k&#160;nemu vyhľadá privátny kľuč, ten má spravidla rovnaké atribúty <em>CKA_ID</em> a&#160;<em>CKA_LABEL</em> ako príslušný certifikát. Na&#160;eID-čku sa dá ZEP/KEP privátny kľúč a&#160;certifikát nájsť aj&#160;podľa špecifického labelu, ale&#160;na to som sa v&#160;aplikácii nechcel spoliehať.<p>Podpísanie PDF-ka má a&#160;starosti knižnica <a href="https://www.nuget.org/packages/itext7/">iTextSharp</a>, program implementuje rozhranie <a href=https://github.com/harrison314/SlovakEidSignTool/blob/master/src/SlovakEidSignTool/Pdf/Pkcs11ExternalSignature.cs>IExternalSignature</a>, v&#160;ktorom prebieha samotné podpísanie PDF-dokumentu. Na&#160;vstup dostane dáta z&#160;PDF-ka, z&#160;ktorých sa vytvorí SHA-256 hash. Z&#160;neho sa vytvorí <em>PKCS#1 digest info</em> (<em>ASN.1</em> dátová štruktúra, ktorá je vhodná na&#160;podpísanie RSA kľúčom).<p>Samotný podpis musí byť v&#160;prípade eID-čka autentifikovaný ZEP PIN-om, ten sa zadáva po&#160;inicializácii podpisovania. Čip v&#160;eID-čku podpíše hash a&#160;vráti podpis. Ten vráti v&#160;metóde rozhrania <a href=https://github.com/harrison314/SlovakEidSignTool/blob/master/src/SlovakEidSignTool/Pdf/Pkcs11ExternalSignature.cs>IExternalSignature</a> a&#160;<em>iTextSharp</em> dokončí podpisovanie a&#160;uloží PDF-ko na&#160;disk.<h2 id=zaver>Záver</h2><p>Princíp realizácie podpisu pomocou slovenského eID je podobný ako podpisovanie inými krypto zariadeniami, ku&#160;ktorým sa pristupuje pomocou štandardu <em>PKCS#11</em>.<p>Ukážkový program využíva knižnice <a href="https://pkcs11interop.net/">PKCS#11 interop</a> na&#160;interakciu z&#160;<em>PKCS#11</em> knižnicou, <a href="https://www.nuget.org/packages/itext7/">iTextSharp</a> pre&#160;manipuláciu s&#160;PDF dokumentom a&#160;<a href=https://github.com/commandlineparser/commandline>CommandLine</a> pre&#160;parsovanie CLI parametrov.<p>Vytvorenie &quot;surového&quot; RSA alebo&#160;EC podpisu je ľahké, ťažšie je to robiť dobre (ochrana PIN-ov, certifikácia softvéru pre&#160;podpis od&#160;NBU, splnenie špecifikácie pre&#160;konkrétne druhy podpisov). Takto podpísané PDF-ko je v&#160;Adobre Readery zelené.<p><img src=images/Programing/SkEidSign/SignedDocument.png class=img-center alt="Signed PDF"><p>No podpis nie je platným <em>eIDAS PAdES</em> podpisom, chýbajú mu rôzne atribúty, odkaz na&#160;podpisovú politiku,&#8230;<h2 id=zdroje>Zdroje</h2><ol><li><a href="https://pkcs11interop.net/">PKCS#11 Interop</a><li><a href=https://github.com/Pkcs11Interop/Pkcs11Interop.X509Store/blob/master/src/Pkcs11Interop.X509Store/Pkcs11X509Certificate.cs>PKCS#11 X509Store</a><li><a href="https://rahulpnath.com/blog/signing-a-pdf-file-using-azure-key-vault/">Signing a&#160;PDF File Using Azure Key Vault</a><li><a href=https://www.slovensko.sk/sk/na-stiahnutie>Slovensko.sk</a></ol></div><div class="col-lg-4 col-md-4 hidden-xs hidden-sm"><div class=well><h4>V&#xFD;voj</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/GitPatch.html>Ako posla&#x165; komit emailom</a><li><a href=/ModerneHtml.html>Renderova&#x165; HTML na serveri nie je hanba</a><li><a href=/InterpolatedStringAsHtmlTemplate.html>Interpolated strings ako HTML &#x161;abl&#xF3;na</a><li><a href=/PqcCert.html>Hybridn&#xE9; certifik&#xE1;ty v C#</a><li><a href=/1brc.html>One Billion Rows Challenge</a><li><a href=/MigraciaBlogu.html>Migr&#xE1;cia blogu</a><li><a href=/PostKvantovaKryptografia.html>Post-kvantov&#xE1; kryptografia v C#</a><li><a href=/BouncyHsm.html>Ako som robil BouncyHsm</a><li><a href=/BuildAutomation.html>Pre&#x10D;o pou&#x17E;&#xED;va&#x165; build automation</a><li><a href=/KeyValueDB.html>Ako na Key-Value datab&#xE1;zu</a><li><a href=/DevelopingAll.html>&#8230;</a></ul></div></div></div><div class=well><h4>V&#x161;eobecn&#xE9;</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/EzoGenerator.html>Gener&#xE1;tor Ezo textov</a><li><a href=/AlternativnyRecept.html>Propag&#xE1;cia alternat&#xED;vnej medic&#xED;ny</a><li><a href=/VotrelciDavnoveku.html>Votrelci d&#xE1;vnoveku</a><li><a href=/GeneralAll.html>&#8230;</a></ul></div></div></div><div class=well><h4>O mne</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/VyvojarskeOdkazy.html>Moje vyvojarske blogy</a><li><a href=/OMne.html>O mne</a><li><a href=/OMneOdkazy.html>Moja tvorba inde</a><li><a href=/Portfolio.html>Portólio</a></ul></div></div></div></div></div><hr><footer><div class="row no-print"><div class="col-lg-8 col-sm-8"><div class=well><h4>Našli ste chybu, alebo chcete niečo doplniť?</h4><p>Ak ste našli chybu v článu, chcete niečo dopniť, alebo sa vyjadriť k téme, môžete na <a href="https://github.com/harrison314/harrison314.github.io/issues/new?title=Podp%C3%ADsanie%20PDF-ka%20Slovensk%C3%BDm%20eID-%C4%8Dkom&amp;body=https%3A%2F%2Fharrison314.github.io%2FSkEidSign.html" target=_blank>Githube otvoriť issue</a>.</div></div></div><div class=row><div class=col-lg-12><p>Copyright &copy; harrison314 2013<span class=on-print> - https://harrison314.github.io/</span></div></div></footer></div><script src=js/jquery.js></script><script src=js/bootstrap.min.js></script>