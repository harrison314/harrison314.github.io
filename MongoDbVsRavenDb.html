<!DOCTYPE html><html lang=sk><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=X-Xss-Protection content="1; mode=block"><meta http-equiv=X-Content-Type-Options content=nosniff><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="RSS Feed" href=feed.rss><meta name=author content=harrison314><meta name=generator content=AspNetStatic><title>MongoDB vs. RavenDB</title><meta property=og:title content="MongoDB vs. RavenDB"><meta property=og:description content="Keď dvaja robia to isté, tak to môže byť úplne iné – porovnanie MongoDB a RavenDB na reálnom projekte."><meta property=og:url content=https://harrison314.github.io/MongoDbVsRavenDb.html><meta property=og:image content=https://harrison314.github.io/images/MongoDbVsRavenDb/media.png><meta name=description content="Keď dvaja robia to isté, tak to môže byť úplne iné – porovnanie MongoDB a RavenDB na reálnom projekte."><link href=css/bootstrap.min.css rel=stylesheet><link href=css/blog-post.css rel=stylesheet><script type=text/x-mathjax-config>
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script><script async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script><link rel=stylesheet href=css/Highiler/vs.css><style>img{max-width:100%}.img-center{display:block;margin-left:auto;margin-right:auto}</style><body><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button> <a class=navbar-brand href=index.html>harrison314 blog</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href=/All.html>Obsah</a><li><a href=/DevelopingAll.html>Programovanie</a><li><a href=/GeneralAll.html>Všeobecné</a><li><a href=/OMne.html>O mne</a></ul></div></div></nav><div class=container><div class=row><div class="col-lg-8 col-md-8"><h1>MongoDB vs. RavenDB</h1><div class=publishDate>August 2022</div><p><strong>Keď robia dvaja to isté, tak to môže byť vo výsledku úplne iné.</strong><p>V tomto článku popisujem to, ako som sa dostal k&#160;MongoDB a&#160;RavenDB, moje skúsenosti s&#160;týmito dokumentovými databázami na&#160;malom reálnom projekte s&#160;reálnymi dátami. Tiež sa snažím zhrnúť rozdiely v&#160;prístupoch pri&#160;implementácii a&#160;problémy, ktoré som musel riešiť.<p>RavenDB popisujem viac, pretože&#160;je o&#160;dosť menej známa ako MongoDB. Treba povedať, že&#160;porovnanie nie je vyčerpávajúce a&#160;plno oblastiam som sa nevenoval. Taktiež predpokladám, že&#160;v ďalších verziách sa veci môžu zmeniť.<h2 id=zoznamenie-sa-s-nosql>Zoznámenie sa s&#160;NoSQL</h2><p>Od strednej školy som sa venoval PHP a&#160;MySQL. Neskôr som na&#160;vysokej škole v&#160;týchto technológiách pokračoval a&#160;aj pracoval (v práci som začal narážať na&#160;limity MySQL). Následne som sa na&#160;inžinierskom štúdiu v&#160;rámci tímového projektu dostal ku&#160;MS SQL a&#160;pri práci som zistil, aké bolo MySQL neschopené a&#160;hlavne pomalé.<p>O rok na&#160;to (2013) v&#160;mojom okolí začal byť hype okolo NoSQL databáz a&#160;začali sa používať aj&#160;tam, kde&#160;by sa nemali. Prednášky o&#160;prechode na&#160;MongoDB sa vždy niesli v&#160;duchu: &quot;<em>použili sme najpomalšiu databázu aká jestvuje (MySQL), s&#160;najpomalším frameworkom v&#160;Pythone alebo&#160;Ruby on Rails a&#160;je to (prekvapivo) pomalé.</em>&quot; A&#160;potom sme prešli na&#160;MongoDB a&#160;je to rýchlejšie. Lenže bolo by to rýchlejšie, keby použijú čokoľvek iné.<p>Medzičasom sa z&#160;MongoDB stal symbol NoSQL sveta.<p><strong>Poznámka:</strong> Pri&#160;materiáloch o&#160;MySQL sa dočítate, že&#160;treba byť s&#160;JOIN-ami opatrní, lebo&#160;sú veľmi pomalé. Pri&#160;materiáloch o&#160;MS SQL sa dočítate, že&#160;sa nemáte báť JOIN-u, lebo&#160;je to najrýchlejšia relačná operácia.<p>Neskôr som si robil nejaké súkromné projekty na&#160;MongoDB, lebo&#160;ma táto databáza niečím fascinovala (možno začiatočníckou jednoduchosťou alebo&#160;BigData pátosom). No&#160;zisťoval som, že&#160;na rovnakom HW je pomalšia ako MS SQL, a&#160;to aj&#160;pri bežných dopytoch tak aj&#160;pri gespatial operáciách. (Asi najextrémnejší rozdiel som pocítil na&#160;databáze importovanej z&#160;<a href="https://download.geonames.org/export/zip/">Geonames</a>, kde&#160;som počítal konvexnú obálku bodov pre&#160;Slovenské mestá – pomocou map-reduce v&#160;Mongu som sa údajom dostal za&#160;4 minúty, keď&#160;som na&#160;to isté použil MS SQL 2016 tak to trvalo 230 ms.)<h2 id=zaciatky-s-ravendb>Začiatky s&#160;RavenDB</h2><p>O RavenDB som sa dozvedel dávnejšie (2016), ale&#160;odradili ma mýty, ktoré okolo tejto databázy panovali (že je pomalá, žerie veľa RAM, že&#160;všetky dokumenty sú v&#160;jednej kolekcii,&#8230;).<p>Neskôr sa mi dostala do&#160;povedomia cez prednášky o&#160;performace .Net Frameworku a&#160;problémoch, ktoré museli prekonať, aby&#160;dosiahli požadovanú rýchlosť.<p>A keď&#160;som sa k&#160;RavenDB konečne dostal a&#160;čítal si o&#160;nej, tak som nechápal, prečo by to niekto používal, veď MongoDB má tie isté featury&#8230;<p>No to bol len prvý pohľad, keď&#160;som sa ponoril hlbšie a&#160;hlavne si vyskúšal indexy, tak som to pochopil v&#160;čom sú hlavné výhody RavenDB. A&#160;vyskúšal som si ju na&#160;niekoľkých projektov.<p>V ďalšom texte zhrňujem niektoré zaujímavé featurey tejto databázy a&#160;porovnávam ju s&#160;MongoDB na&#160;jednom konkrétnom projekte - <a href=https://github.com/harrison314/Area52>Area52</a>.<h2 id=co-je-to-ravendb>Čo je to RavenDB</h2><p>RavenDB je open-source, dokumentová, distribuovaná, NoSQL databáza, ktorá je od&#160;svojho vzniku (2010) podporuje transakcie a&#160;je na&#160;stavaná. Taktiež podporuje master-to-master replikáciu. Je vyvíjaná spoločnosťou <em>Hibernating Rhinos Ltd</em>.<p>To asi nepovedalo veľa, tak skúsim opísať jej principiálne fungovanie (implementačné detaily sa môžu líšiť).<p>RavenDB má v&#160;jadre key-value databázu nazývanú <a href=https://ravendb.net/docs/article-page/5.3/csharp/server/storage/storage-engine>Voron</a>, kde&#160;kľuč je ID dokumentu a&#160;hodnota je JSON dokument. Táto databáza je full ACID a&#160;MVCC. Taktiež je vďaka časovým značkám ku&#160;hodnotám veľmi ľahko distribuovateľná a&#160;replikovateľná aj&#160;pri výpadkoch spojenia.<p>Nad touto internou databázou je postavený indexovací engin pomocou upraveného <em>Lucene.Net</em> (od verzie 5.4 by mal byť dostupný aj&#160;nový engin <a href=https://ravendb.net/about/roadmap>Corax</a>). Index v&#160;ponímaní RavenDB by sa dal predstaviť vo svete relačných databáz ako materializovaný pohľad, nad ktorým sú ďalšie indexy. Takže v&#160;indexe ide robiť filtrovanie, transformácie, výpočty (jeden dokument môže mať v&#160;indexe 0 až N položiek). A&#160;to nie je všetko, keďže RavenDB sa tvári ako keby všetky dokumenty sú v&#160;jednej kolekcii, tak je do&#160;jedného indexu možné vytiahnuť dokumenty s&#160;viacerých kolekcií, v&#160;rámci indexu robiť niečo ako JOIN. Je možné použiť map-reduce indexy. A&#160;keďže sa ako indexovací engin používa <em>Lucene.Net</em>, tak RavenDB má k&#160;dispozícii funkcionlitu podobnú ako <em>ElasticSerach</em>.<p>No tu treba upozorniť na&#160;to, že&#160;všetky operácie nad dokumentmi (insert, update, delete, modifikácia a&#160;vyhľadanie podľa ID,&#8230;) majú garantované ACID správanie, no&#160;indexy sú len eventuálne konzistentné, respektíve môžeme to považovať za&#160;implementáciu CQRS (ale cez API je možné zistiť stav indexu a&#160;výsledkov).<p>Nad tým všetkým je ešte&#160;query procesor, processing engine a&#160;<em>RavenDB Studio</em>.<p>RavenDB ďalej poskytuje podporu časových sérií, distributed counters, geospatial index, subscriptions, súborové prílohy dokumentov, revízie dokumentov, hromadné patche, atomické operácie, substcribtions, notifications, možnosť použiť embedded verziu, priamo databáza obsahuje administračné GUI, v&#160;ktorom je naozaj všetko,&#8230; a&#160;mnohé mnohé ďalšie funkcionality a&#160;integrácie (na Kafku, RabbitMQ, Graphanu, SQL databázy,&#8230;).<h2 id=mongodb-vs.ravendb-na-realnom-projekte>MongoDB vs. RavenDB na&#160;reálnom projekte</h2><p>MongoDB a&#160;RavenDB som si chcel vyskúšať na&#160;niečom reálnom (a hlavne vhodnom pre&#160;dokumentovú databázu). Tak som si spravil projekt, ktorý&#160;umožňuje ukladať a&#160;vyhľadávať v&#160;štruktúrovaných logoch (sú to nerelačné dáta a&#160;dá sa ich zohnať alebo&#160;vytvoriť dostatočné množstvo).<p>Navyše existujúce riešenia ako <a href=https://www.elastic.co/what-is/elk-stack>ELK stack</a>, Loki, či&#160;<a href=https://datalust.co/seq>Seq</a> mi v&#160;niečom nevyhovovali.<p>Tak vznikol projekt <a href=https://github.com/harrison314/Area52>Area52</a>.<p>Area52 umožňuje vyhľadávať v&#160;štruktúrovaných logoch pomocou vlastného dopytovacieho jazyka, ktorý&#160;sa prekladá do&#160;dopytovacieho jazyku príslušnej databázy.<p>Časové rady, ktoré podporujú obe databázy, šlo použiť pri&#160;vykresľovaní grafov rôznych udalostí alebo&#160;metrík z&#160;logov (napríklad počet chýb za&#160;deň, priemerného času odpovede servera, tržby,&#8230;).<p>V nasledujúcich podkapitolách ukážem rozdiely pri&#160;práci s&#160;týmito dvoma databázami (údaje o&#160;nich sa vzťahujú na&#160;dobu vydania tohto článku).<h3 id=ukladanie-dokumentov>Ukladanie dokumentov</h3><p>Prvý najviac očividný rozdiel je to, že&#160;v MongoDB musí mať každý dokument svoje ID priamo v&#160;sebe. V&#160;RavenDB dokument nemusí obsahovať svoje ID (interne ho neobsahuje ani&#160;keď je v&#160;modeli).<p>Klient RavenDB používa <em>Unit of Work</em> pattern a&#160;preto ide napríklad zistiť ID dokumentu ešte&#160;pred tým, ako sa uloží (keď chceme ukladať súvisiace dokumenty v&#160;transakcii).<p>Tu celkovo MongoDB ťahá za&#160;kratší koniec, lebo&#160;som musel denormalizovať denormalizovaný dokument, a&#160;pridať doň filedy, ktoré potrebovali indexy alebo&#160;vyhľadávanie a&#160;tiež field pre&#160;fulltext a&#160;samozrejme pridať do&#160;dokumentu filed s&#160;jeho verziou. Celkovo v&#160;MongoDB treba občas ukladať tie isté dáta na&#160;viackrát do&#160;rôznych kolekcií.<p>Zatiaľ, čo&#160;RavenDB tento neduh eliminuje indexmi a&#160;možnosťou hromadného patchu dokumentov.<p>MongoDB má umelý limit na&#160;veľkosť dokumentu <em>16MB</em>, tento limit platí aj&#160;na všetky operácie s&#160;ním (aj na&#160;vstup a&#160;výstup), RavenDB nemá maximálny limit pre&#160;dokumenty ale&#160;technicky sú to <em>2GB</em> (no neodporúča používať tak veľké JSON-y).<p><strong>Príklad v&#160;projekte:</strong> V&#160;projekte Area52 do&#160;RavenDB ukladám priamo doménový objekt pre&#160;štruktúrovaný log. Zatiaľ, čo&#160;v prípade MongoDB som musel implementovať databázové modely, lebo&#160;potrebovali dodatočné filedy (field pre&#160;fulltext vyhľadávanie, fieldy pre&#160;hodnoty pre&#160;case insesnitive vyhľadávanie,&#8230;), verziu a&#160;ID. Podobné to bolo pri&#160;ostatných doménových objektoch.<p>Čo sa týka zabraného miesta na&#160;disku, tak obe databázy boli vo výsledku na&#160;tom rádovo rovnako.<h3 id=transakcie>Transakcie</h3><p>Ako som už spomínal RavenDB je od&#160;začiatku navrhnutá s&#160;podporou transakcií, v&#160;API sa používajú implicitne a&#160;fungujú vždy a&#160;všade.<p>MongoDB už multi-dokumentové transakcie už má, no&#160;cesta k&#160;nim bola tŕnistá. Nejakú podporu transakcií má Mongo od&#160;verzie 3.4, no&#160;nie vždy fungovali v&#160;rámci clastru a&#160;dlho mali obmedzenie na&#160;<em>16MB</em> dát (do verzie 4.2). Takisto sa v&#160;čase menilo správanie transakcií a&#160;aj v&#160;kombinácii s&#160;nastavením serveru (podľa toho, čo&#160;som čítal bolo potrebné mať na&#160;serveri nastavené potvrdzovanie zápisov aby&#160;fungovali spoľahlivo, niektoré transakčné API neboli dostupné v&#160;komunitnej verzii, transakcie sa správali inak ak sa prevádzkoval jeden nod a&#160;inak ak ich bolo viac).<p>MongoDB používa pre&#160;transakcie explicitné API, oficálna dokumentácia používateľov <a href=https://www.mongodb.com/basics/acid-transactions>odrádzajú od&#160;ich použitia</a>, defaultné nastavenia serveru negarantujú <em>durability</em> a&#160;na svojich stránkach varujú, že&#160;použitie transakcií má veľmi negatívny dopad na&#160;výkon - <a href="https://www.mongodb.com/docs/manual/core/transactions/">https://www.mongodb.com/docs/manual/core/transactions/</a>.<p><strong>Príklad v&#160;projekte:</strong> V&#160;projekte Area52 používam implicitné transakcie pre&#160;RavenDB. No&#160;pre MongoDB nie a&#160;to hlavne kvôli výkonu a&#160;tomu, že&#160;klientska strana nevie zaručiť durability.<h3 id=indexy>Indexy</h3><p>MongoDB používa to, čo&#160;si ako prvé predstavíme pod klasickými indexmi. Podporuje indexy pre&#160;jeden filed, zložené indexy, gesopatial indexy, TTL indexy (<em>len prečo je na&#160;to potrebné vytvárať samostatný index?</em>), je možné indexovať aj&#160;polia a&#160;v novších verziách aj&#160;filtrované indexy. No&#160;nie vždy plánovač tieto indexy aj&#160;využije. A&#160;je tu obmedzenie na&#160;to, že&#160;kolekcia môže mať len jeden fulltext index. Celkovo sú to štandardné indexy.<p>V RavenDB sú indexy úplne iná káva. Je to takmer „strieborná guľka“ a&#160;takmer akýkoľvek problém ide v&#160;tejto databáze vyriešiť indexom.<p>Indexy sa definujú deklaratívnym kódom, umožňujú:<ul><li>kombinovanie polí v&#160;indexoch,<li>vykonávanie výpočtov v&#160;indexoch,<li>agregáciu dokumentov pred indexovaním (dá sa to predstaviť ako náhrada JOIN-u),<li>filtrovanie dokumentov alebo&#160;naopak indexovanie viacerých hodnôt s&#160;dokumentu,<li>podpora indexovanie hierarchických hodnôt,<li>podpora indexovania countrov, časových sérií a&#160;príloh v&#160;rámci dokumentu,<li>pre výpočty a&#160;spracovanie dát v&#160;indexoch použiť vlastný kód a&#160;knižnice (C# a&#160;JavaScript),<li>ukladať hodnoty do&#160;indexov,<li>dynamické indexy (dynamické vytváranie položiek v&#160;indexe),<li>geospatial indexy,<li>indexovanie dokumentov z&#160;viacerých kolekcií do&#160;jedného indexu,<li>samostatný fulltext s&#160;rôznym nastavením pre&#160;jednotlivé fieldy,<li>map-reduce indexy&#8230;</ul><p>Samozrejme tieto všetky vlastnosti idú kombinovať. Indexy sa dopočítavajú asynchrónne (na štýl CQRS), takže nespomaľujú operácie s&#160;dokumentmi, to má ale&#160;aj nevýhodu v&#160;tom, že&#160;nie je možné vytvoriť uniq constraint (čo naopak MongoDB umožňuje). Možnosti indexovania sú v&#160;RavenDB naozaj ohromné a&#160;ako som spomínal indexy tu skôr pripomínajú materializované pohľady.<p>Pár príkladov:<ul><li>Pekný príklad je <em>„CASCADE DELETE“</em> – Mongo niečo také nepodporuje a&#160;človek si musí dané dokumenty načítať, vytiahnuť interpretovať a&#160;vytiahnuť si súvisiace dokumenty a&#160;následne to zmazať. V&#160;RavenDB je na&#160;to možné použiť multimap index a&#160;mazať priamo podľa neho.<li>Univerzálne fulltext vyhľadávanie - vďaka multimap indexom je možné vytvoriť vyhľadávanie cez viaceré kolekcie (napr: používatelia, články a&#160;komentáre).<li>Map-reduce indexy - nahradzujú klasický map-reduce a&#160;agregácie, len s&#160;tým, že&#160;výsledky sú predpočítané a&#160;indexované dopredu, takže vyhľadávanie v&#160;nich je rýchle a&#160;o aktuálnosť sa stará databáza.</ul><p>Možnosti indexov v&#160;RavenDB majú vplyv aj&#160;na to ako vyzerá databázová schéma. V&#160;štandardnej dokumentovej databáze je potrebné ukladať dáta na&#160;viackrát do&#160;rôznych kolekcií, lebo&#160;v aplikácii sú na&#160;ne potrebné rôzne pohľady alebo&#160;je to potrebné hľadiska výkonu - <a href="https://www.youtube.com/watch?v=2cZpC94P2Pw">https://www.youtube.com/watch?v=2cZpC94P2Pw</a> (pri tom by sa hodili transakcie, však). Toto RavenDB svojimi indexami do&#160;značnej miery eliminuje. Tiež to uľahčuje situáciu, keď&#160;je treba zmeniť aplikáciu, proste sa len pridá alebo&#160;zmení index a&#160;dokumenty sa nemusia verzovať alebo&#160;updatovať. Takže komplexitu schémy a&#160;aplikačnej logiky sa dá preniesť na&#160;plecia deklaratívnych indexov.<p><strong>Poznámka:</strong> To, že&#160;je bezschémová databáza agilnejšia, respektíve dokumentová databáza je agilnejšia ako relačná považujem za&#160;veľmi rozšírený mýtus. Pretože&#160;jednak schéma databázy je v&#160;aplikácii a&#160;s dátami neznámej schémy sa nedá dobre pracovať. Druhá vec je, že&#160;pri návrhu schémy treba vedieť dopredu, aké dopyty budú použité (a to tvrdia priamo ľudia z&#160;Monga – <a href="https://www.youtube.com/watch?v=2cZpC94P2Pw">https://www.youtube.com/watch?v=2cZpC94P2Pw</a>). Zatiaľ čo&#160;pri relačnom modely sa prosto začne s&#160;normalizovaným modelom a&#160;následne je možné sa dopytovať na&#160;akékoľvek dáta.<p><strong>Príklad v&#160;projekte:</strong> Pre&#160;kolekciu logov mám v&#160;projekte 6 samostatných indexov pre&#160;MongoDB, navyše sa preň musia v&#160;aplikácii dopočítavať dodatočné filedy pre&#160;vyhľadávanie. V&#160;RavenDB je to riešené jediným indexom.<p>Nasleduje ukážka multimap-reduce indexu, ktorý&#160;rieši detail pre&#160;korpus-dokument v&#160;inom projekte, ktorý&#160;sa zaoberá kontrolou plagiátorstva:<div class="lang-cs editor-colors"><div style=color:Black;background-color:White><pre>
<span style=color:Blue>public</span> <span style=color:Blue>class</span> CorpusWithDocCountIndex : AbstractMultiMapIndexCreationTask&lt;CorpusWithDocCountIndex.Result&gt;
{
    <span style=color:Blue>public</span> <span style=color:Blue>class</span> Result
    {
        <span style=color:Blue>public</span> <span style=color:Blue>string</span> Id
        {
            <span style=color:Blue>get</span>;
            <span style=color:Blue>set</span>;
        }

        <span style=color:Blue>public</span> <span style=color:Blue>string</span>? Name
        {
            <span style=color:Blue>get</span>;
            <span style=color:Blue>set</span>;
        }

        <span style=color:Blue>public</span> <span style=color:Blue>string</span>? UserId
        {
            <span style=color:Blue>get</span>;
            <span style=color:Blue>set</span>;
        }

        <span style=color:Blue>public</span> CorpusType? Type
        {
            <span style=color:Blue>get</span>;
            <span style=color:Blue>set</span>;
        }

        <span style=color:Blue>public</span> <span style=color:Blue>int</span> DocumentCount
        {
            <span style=color:Blue>get</span>;
            <span style=color:Blue>set</span>;
        }
    }

    <span style=color:Blue>public</span> CorpusWithDocCountIndex()
    {
        <span style=color:Blue>this</span>.AddMap&lt;Corpus&gt;(corpuses =&gt; <span style=color:Blue>from</span> c <span style=color:Blue>in</span> corpuses
                                      <span style=color:Blue>select</span> <span style=color:Blue>new</span> Result()
                                      {
                                          Id = c.Id,
                                          UserId = c.Owner.UserId,
                                          DocumentCount = 0,
                                          Name = c.Name,
                                          Type = c.Type
                                      });

        <span style=color:Blue>this</span>.AddMap&lt;Document&gt;(documents =&gt; <span style=color:Blue>from</span> q <span style=color:Blue>in</span> documents
                                        <span style=color:Blue>select</span> <span style=color:Blue>new</span> Result()
                                        {
                                            Id = q.Corpus.Id,
                                            UserId = <span style=color:Blue>null</span>,
                                            DocumentCount = 1,
                                            Name = <span style=color:Blue>null</span>,
                                            Type = <span style=color:Blue>null</span>
                                        });

        <span style=color:Blue>this</span>.Reduce = t =&gt; t.GroupBy(q =&gt; q.Id)
        .Select(k =&gt; <span style=color:Blue>new</span> Result()
        {
            Id = k.Key,
            DocumentCount = k.Sum(q =&gt; q.DocumentCount),
            Name = k.Select(q =&gt; q.Name).FirstOrDefault(q =&gt; q != <span style=color:Blue>null</span>),
            Type = k.Select(q =&gt; q.Type).FirstOrDefault(q =&gt; q != <span style=color:Blue>null</span>),
            UserId = k.Select(q =&gt; q.UserId).FirstOrDefault(q =&gt; q != <span style=color:Blue>null</span>)
        });

        <span style=color:Blue>this</span>.Index(t =&gt; t.UserId, FieldIndexing.Exact);
    }
}
</pre></div></div><h3 id=dopytovanie>Dopytovanie</h3><p>Asi najvýraznejší rozdiel medzi MongoDB a&#160;RavenDB je v&#160;dopytovanom jazyku.<p>MongoDB má tri spôsoby ako sa dopytovať do&#160;databázy:<ul><li>vyhľadanie a&#160;projekcia dokumentov z&#160;kolekcie (find + projection),<li>agregačný framewrok (postup krokov skladajúcich sa z&#160;krokov s&#160;filtrovaním, projekciou a&#160;grupovanim)<li>map-reduce (ako javascript funkcie, no&#160;dnes je už preferovaný agregačný framework).</ul><p>Budem sa tu venovať prvým dvom spôsobom získavania dát. Prvý je jednoduché filtrovanie s&#160;voliteľnou projekciou. Druhý je agregačný framewrok, v&#160;ktorom je možné veľmi flexibilne kombinovať kroky, čo&#160;má svoje výkonové dopady, ale&#160;zas veľkú vyjadrovaciu silu.<p>V oboch prípadoch sa na&#160;definíciu dopytovania, grupovania a&#160;projekcií používajú BSON dokumenty. Čo&#160;nie je príliš pekné ani&#160;krátke, lebo&#160;ide o&#160;kombináciu stringov, BSON dokumentov a&#160;polí, ktoré sa zanorujú do&#160;seba. V&#160;javascripte je tento zápis relatívne stručný. Napríklad:<div class="lang-js editor-colors"><div style=color:Black;background-color:White><pre>
db.inventory.find({ $or: [{ status: <span style=color:#A31515>&quot;A&quot;</span> }, { qty: { $lt: 30 }}]})
</pre></div></div><p>No v&#160;typových jazykoch nepríjemne rastie a&#160;stáva sa neprehľadný so&#160;zvyšujúcou sa komplexitou a&#160;je ľahké sa stratiť v&#160;záplave zátvoriek a&#160;stringových operátorov.<p>Tiež tu máme to nepríjemné obmedzenie veľkosti spracovaných dokumentov na&#160;výstupe a&#160;v medzi-krokoch.<p>RavenDB používa jazyk <em>RQL</em>, ktorý&#160;sa najviac podobá <em>LINQ-u</em> (a ten sa podobá SQL-ku), umožňuje jednoducho vyjadriť filtrovanie a&#160;projekcie. Pre&#160;mňa je tento jazyk oveľa jednoduchší a&#160;intuitívnejší, ako skladanie vnorených BSON dokumentov. Navyše RavenDB klient má silnú podporu LINQ-u v&#160;C#, takže človek sa jednoducho dopytuje v&#160;typovom jazyku (ostatné drivre pre&#160;iné jazyky majú k&#160;tomu svoju alternatívu).<p>Predchádzajúci príklad by mal v&#160;RQL takúto alternatívu (s indexom pre&#160;<code>status</code> a&#160;<code>qty</code>):<pre><code>from index 'Inventory/Base'
where status = 'A' or qty &lt; 30
</code></pre><p>Pri dopytovaní treba poznamenať, že&#160;v RavenDB sa dopytuje a&#160;triedi vždy cez index (takže sa Ad-hoc dopytmi to nie je také jednoduché). Ak sa v&#160;C# klientovi (v defaultnom nastavení) pokúsite dopytovať priamo na&#160;fieldy dokumentov, tak dostanete výnimku s&#160;tým, že&#160;sa máte dopytovať na&#160;index. RavenDB ale&#160;dokáže pri&#160;prvom dopyte vytvoriť potrebný index a&#160;použiť ho, ale&#160;nie je to odporúčané (hlavne nie v&#160;produkcii). Navyše tým, že&#160;sa explicitne uvedie index, máte istotu, že&#160;sa použije.<p>Trošku komplikovanejšie je to agregáciami, tie v&#160;RavenDB ide použiť len cez map-reduce index, alebo&#160;cez facet-y.<p>Viac o&#160;rozdieloch v&#160;dopytovaní (MongoDb vs. RavenDB so&#160;zameraním na&#160;agregácie) je možné nájsť tu <a href="https://www.youtube.com/watch?v=1g-6XocHG6U">https://www.youtube.com/watch?v=1g-6XocHG6U</a>.<p><strong>Príklad v&#160;projekte:</strong> Na&#160;nasledujúcom obrázku je príklad dopytu v&#160;MogoDb (naľavo) a&#160;RavenDB (napravo) pre&#160;zistenie podielu aplikácií v&#160;logoch. Dopyty sú na&#160;tie isté štruktúry a&#160;obe majú indexy.<p><img src=images/MongoDbVsRavenDb/MongoVsRavenQuery.jpeg class=img-center alt="MongoDB vs. RavenDB query."><p>Celkovo všetky dopyty pre&#160;MobgoDb boli 4 až 8-krát dlhšie ako v&#160;prípade RavenDB. Taktiež mi pre&#160;MongoDB chýbali operácie na&#160;prácu so&#160;stringami (napr. <code>startsWith</code>).<h3 id=casove-rady-timeseries>Časové rady - TimeSeries</h3><p>Časové rady v&#160;MongoDB sú implementované ako špeciálna kolekcia, ktorá používa ako ID čas udalosti. Dopytuje sa naň cez agregačný framework.<p>RavenDB má časové rady naviazané na&#160;dokument, v&#160;ktorom ich môže byť viac a&#160;sú pomenované. Na&#160;dopytovanie používa RQL ale&#160;pre operácie nad časovými radmi má vlastnú sadu agregačných funkcií a&#160;veľmi dobré možnosti ako učiť časové okno pre&#160;agregáciu, navyše je možné kombinovať rôzne časové rady.<p><strong>Príklad v&#160;projekte:</strong> Tu je rovnaká situácia ako pri&#160;dopytovaní – dopyt pre&#160;časové rady je RavenDB výrazne kratší. V&#160;MongoDB som vytvoril len jednu kolekciu pre&#160;časové rady a&#160;rôzne hodnoty pre&#160;časové rady oddeľujem tagom, to asi nie je najlepšie riešenie, ale&#160;dynamicky vytvárať nové kolekcie sa tiež neodporúča. V&#160;RavenDB som mohol vytvárať samostatnú časovú radu pre&#160;každú používateľskú definíciu. Taktiež časové okno šlo určiť presne, zatiaľ čo&#160;v Mongu to bol vždy len derivát časového údaju (rozumej granularita len na&#160;hodinu, minútu, sekundu, deň, mesiac,&#8230;).<h3 id=subscriptions>Subscriptions</h3><p>V tejto podkapitole je porovnaný mechanizmus umožňujúci sledovať zmeny v&#160;kolekcii z&#160;klientskej aplikácie a&#160;reagovať na&#160;ne. Ide pomocou neho implementovať napríklad background processing.<p>V MongoDB nazývané <em>Changed streams</em> slúžia pre&#160;informovanie aplikácií o&#160;zmenách dokumentov v&#160;kolekcii. No&#160;majú viac formu notifikácií. Je v&#160;nich možné použiť token pre&#160;pokračovanie v&#160;sledovaní pri&#160;výpadku aplikácie ale&#160;o jeho ukladanie a&#160;použitie si musí aplikácia riešiť sama.<p><strong>Poznámka:</strong> <em>Changed streams</em> v&#160;MongoDB funguje len keď&#160;je spustený ako <em>replica set</em>.<p>V RavenDB sa toto celé rieši na&#160;strane serveru a&#160;spracovanie dokumentov aj&#160;pri subsripcii je transakčné, zabezpečuje, že&#160;rovnakú zmenu nezachytia dve aplikácie.<p><strong>Príklad v&#160;projekte:</strong> Túto vlastnosť som nepoužil v&#160;Area52, ale&#160;v inom projekte, kde&#160;som ju používal pre&#160;spracovávanie novo pridaných textových dokumentov (MS Office dokumenty a&#160;PDF-ka).<h2 id=zhrnutie-databaz>Zhrnutie databáz</h2><p>V tejto kapitole uvádzam krátke subjektívne zhrnutie týchto dvoch databáz a&#160;pridávam nejaké postrehy.<h3 id=mongodb>MongoDB</h3><p>MongoDB za&#160;svoju existenciu ubehlo dlhú cestu a&#160;zlepšuje sa (od hlúpeho úložiska s&#160;map-reduce ku&#160;úložisku s&#160;agregačným frameworkom, časovými sériami atď.).<p>Čo sa mi páči:<ul><li>Dokumentácia.<li>Veľká komunita vďaka rozšírenosti.<li>Verzia zadarmo má minimálne obmedzenia (no nejaké sú) a&#160;nelimituje výkon.<li><em>GridFS</em> (MongoDB je vhodnejšia databáza na&#160;ukladanie binárnych dát).</ul><p>Čo sa mi nepáči:<ul><li>Komplikovaný dopytovaní (ne)jazyk.<li>Chýbajú elementárne operácie so&#160;stringami.<li>Ku reálnym transakciám sa dá veľmi ťažko dopracovať a&#160;to aj&#160;za cenu poklesu výkonu.<li>Vlastnosti a&#160;správanie featúr sa veľmi menili medzi verziami, z&#160;čoho vzniká chaos pri&#160;radách, článkoch a&#160;<em>best practice</em>.<li>Nemožnosť master-master replikácie.<li><em>GridFS</em> nepodporuje transakcie.<li>Veľmi slabé administračné GUI, kde&#160;nejde prakticky nič nastaviť alebo&#160;si pozrieť.<li>MongoDB klame, v&#160;administračnom GUI sa dozviem, že&#160;dáta v&#160;databáze majú s&#160;indexami <em>16MB</em> ale&#160;na disku majú <em>370MB</em>.<li>C# driver vie serilizovať štruktúry ale&#160;už ich nevie deserializovať.</ul><h3 id=ravendb>RavenDB</h3><p>RavenDB na&#160;mňa pôsobí veľmi solídnym dojmom, kde&#160;kombinuje zaujímavé koncepty. Vyžaduje trochu iný prístup, na&#160;aký sú programátori zvyknutý. Taktiež sa o&#160;nej menej hovorí a&#160;vie, čo&#160;je podľa mňa veľká škoda.<p>Čo sa mi páči:<ul><li>Reálne transakcie a&#160;ACID.<li>Atomické commandy.<li>Indexy, indexy, indexy.<li>Lazy queries (mechanizmus umožňujúci odoslať viac dopytov na&#160;server v&#160;jednej dávke a&#160;tým znížiť celkový čas odozvy a&#160;priepustnosť).<li>Podpora integračného testovania.<li>Dokumentácia.<li>Spracovanie textu (v podstate vie nahradiť funkcionalitu <em>ElasticSerach</em>).<li>Rýchlosť. Napriek verzii obmedzenej na&#160;tri jadrá a&#160;<em>6GB RAM</em>, bola RavenDB rýchlejšia pre&#160;niektoré dopyty a&#160;inserty ako MongoDB na&#160;ôsmich jadrách a&#160;<em>16GB RAM</em>, cítiť to bolo hlavne pri&#160;agregáciách.<li>Priamo súčasťou databázy je perfektné administračné GUI (obrázky nižšie), v&#160;ktorom ide nastaviť všetko, od&#160;vlastností databázy až po&#160;cluster. Je v&#160;ňom možné prezrieť stav úložiska, dokonca vliezť do&#160;indexov a&#160;pozrieť sa ako sú zaindexované hodnoty a&#160;ako vyzerá zvnútra, či&#160;si vizualizovať vnútornosti map-reduce indexu, backupy, performace hinty a&#160;mnoho mnoho ďalšieho. A&#160;toto GUI neklame, keď&#160;máte na&#160;disku <em>300MB</em> databázu, tak sa to dozviete aj&#160;z GUI.<li>Otvorenosť. A&#160;to nemyslím len otvorenosť zdrojových kódov. Ale&#160;to, že&#160;tvorcovia RavenDB vo svojich blogoch a&#160;prednáškach opisujú, ako fungujú vnútornosti databázy a&#160;hlavne prečo sa rozhodli veci riešiť tak ako sa rozhodli. K&#160;tejto otvorenosti prispieva aj&#160;spomínané administračné GUI.<li>Jednoduchší dopytovací jazyk, priateľskejší klient pre&#160;C#.<li>Mám pocit, že&#160;celé to má nejaký koncept a&#160;smer, že&#160;tvorcovia nad RavenDB a&#160;jej použitím rozmýšľajú.</ul><p>Čo sa mi nepáči:<ul><li>Dosť obmedzená komunitná licencia, čo&#160;podľa mňa bráni širšiemu rozšíreniu, zišlo by sa pridať pár jadier procesora pre&#160;cluster.<li>Príloha nejde čítať po&#160;častiach (otvoril som na&#160;to diskusiu).<li>V defultnom nastavení majú ID-čka tvar, ktorý&#160;nie je vhodné posielať von zo&#160;systému (dá sa to zmeniť, alebo&#160;upraviť, no&#160;je to nejaká malá práca navyše).</ul><p><img src=images/MongoDbVsRavenDb/RavenStudio1.png class=img-center alt="RavenDB Studio - IO usage."><p class="text-center font-italic" :="">RavenDB Studio - Vizualizácia dát na&#160;disku pre&#160;databázu.<p class="text-center font-italic" :=""><img src=images/MongoDbVsRavenDb/RavenStudio2.png class=img-center alt="RavenDB Studio - Index internals."> RavenDB Studio - Zobrazenie hodnôt v&#160;indexe.<p class="text-center font-italic" :=""><img src=images/MongoDbVsRavenDb/RavenStudio3.png class=img-center alt="RavenDB Studio - Ukážka dokumentu."> RavenDB Studio – Zobrazenie dokumentu s&#160;rozkliknutými časovými radmi.<p class="text-center font-italic" :=""><img src=images/MongoDbVsRavenDb/RavenStudio4.png class=img-center alt="RavenDB Studio - Map-Reduce index."> RavenDB Studio – Vizualizácia map-reduce indexu.<h2 id=zhodnotenie>Zhodnotenie</h2><p>Na začiatku som opisoval moje skúsenosti s&#160;relačnými databázami, lebo&#160;mi príde, že&#160;MongoDB je MySQL dokumentových databáz - veľmi rozšírená, obľúbená databáza, ktorá sa stala defakto štandardom a&#160;každý po&#160;nej siahne, lebo&#160;o nej počul. Síce má množstvo featúr, no&#160;pôsobia nedokončene a&#160;polovičato. Pričom RavenDB by som prirovnal k&#160;MS SQL, síce platená, ale&#160;s premyslenými featurami, ktoré fungujú. Má k&#160;dispozícii plnohodnotný administračný nástroj, v&#160;ktorom ide spravovať databázu, kontrolovať a&#160;ladiť výkon,&#8230; a&#160;to bez&#160;toho, aby&#160;sa človek musel v&#160;konzole písať komandy, alebo&#160;nastavovať konfiguračné súbory v&#160;proprietárnom formáte.<p><strong>MongoDB</strong> by som uprednostnil v&#160;prípadoch, keď&#160;na ACID vlastnostiach až tak nezáleží, a&#160;v prípadoch, ak je potrebné len úložisko dát.<p><strong>RavenDB</strong> by som uprednostnil tam, kde&#160;ide o&#160;peniaze a&#160;o zdravie – ACID, tam, kde&#160;je potrebné viac pracovať s&#160;dátami (hlavne z&#160;rôznych zdrojov), tam, kde&#160;ide o&#160;vyhľadávanie a&#160;spracovanie textu alebo&#160;sa hodí CQRS architektúra kvôli výkonu,&#8230;<p>MongoDB bola láska na&#160;prvý pohľad, je to zaujímavá databáza, ale&#160;RavenDB je zaujímavejšia.<h2 id=zdroje>Zdroje</h2><ol><li><a href="https://www.youtube.com/watch?v=P4T7MOlxsUs">https://www.youtube.com/watch?v=P4T7MOlxsUs</a> - KROS Dev Meetup #7 -RavenDB is a&#160;NoSQL Document Database (Marián &quot;vlko&quot; Vlčák)<li><a href="https://www.youtube.com/watch?v=1e6dS9jSQWo">https://www.youtube.com/watch?v=1e6dS9jSQWo</a> - RavenDB: a&#160;really boring database! with Dejan Miličić (ukážka RavenDB pre&#160;začiatočníkov)<li><a href="https://indexoutofrange.com/RavenDBvsMongoDB/">https://indexoutofrange.com/RavenDBvsMongoDB/</a> - RavenDB vs MongoDb<li><a href="https://www.youtube.com/watch?v=2cZpC94P2Pw">https://www.youtube.com/watch?v=2cZpC94P2Pw</a> - The Developer's Guide to Data Modelling with Document Databases - Adrienne Braganza Tacke<li><a href="https://www.youtube.com/watch?v=1g-6XocHG6U">https://www.youtube.com/watch?v=1g-6XocHG6U</a> - MapReduce: RavenDB vs MongoDB<li><a href="https://www.youtube.com/watch?v=5ZXBR3croMA">https://www.youtube.com/watch?v=5ZXBR3croMA</a> - MongoDB vs RavenDB: Which Document Database Conquers ACID?<li><a href="https://www.youtube.com/watch?v=Jd1vYmhwpAQ">https://www.youtube.com/watch?v=Jd1vYmhwpAQ</a> - Migrating from RavenDB 2.5 to 4.0 in 36,000 Locations<li><a href="https://www.youtube.com/watch?v=qeWY1RuIlaE">https://www.youtube.com/watch?v=qeWY1RuIlaE</a> - ExDav proj - MongoDB, CosmosDB, CalDAV, MS Graph [M. Melena, HAVIT Vzdělávací okénko, 23.2.2022]<li><a href="https://ayende.com/blog/">https://ayende.com/blog/</a> - Oren Eini aka Ayende Rahien (blog CEO <em>Hibernating Rhinos</em>)<li><a href=https://ravendb.net/docs/article-page/5.4/csharp>https://ravendb.net/docs/article-page/5.4/csharp</a> - RavenDB dokumentácia<li><a href="https://alex-klaus.com/ravendb-pain-and-joy/">https://alex-klaus.com/ravendb-pain-and-joy/</a> - RavenDB. Two years of pain and joy<li><a href="https://www.mongodb.com/docs/">https://www.mongodb.com/docs/</a> - MongoDB dokumentácia<li><a href="https://analyticsindiamag.com/the-good-the-bad-and-the-ugly-the-story-of-mongodb/">https://analyticsindiamag.com/the-good-the-bad-and-the-ugly-the-story-of-mongodb/</a> - The good, the bad and the ugly – the story of MongoDB</ol></div><div class="col-lg-4 col-md-4 hidden-xs hidden-sm"><div class=well><h4>V&#xFD;voj</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/GitPatch.html>Ako posla&#x165; komit emailom</a><li><a href=/ModerneHtml.html>Renderova&#x165; HTML na serveri nie je hanba</a><li><a href=/InterpolatedStringAsHtmlTemplate.html>Interpolated strings ako HTML &#x161;abl&#xF3;na</a><li><a href=/PqcCert.html>Hybridn&#xE9; certifik&#xE1;ty v C#</a><li><a href=/1brc.html>One Billion Rows Challenge</a><li><a href=/MigraciaBlogu.html>Migr&#xE1;cia blogu</a><li><a href=/PostKvantovaKryptografia.html>Post-kvantov&#xE1; kryptografia v C#</a><li><a href=/BouncyHsm.html>Ako som robil BouncyHsm</a><li><a href=/BuildAutomation.html>Pre&#x10D;o pou&#x17E;&#xED;va&#x165; build automation</a><li><a href=/KeyValueDB.html>Ako na Key-Value datab&#xE1;zu</a><li><a href=/DevelopingAll.html>&#8230;</a></ul></div></div></div><div class=well><h4>V&#x161;eobecn&#xE9;</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/EzoGenerator.html>Gener&#xE1;tor Ezo textov</a><li><a href=/AlternativnyRecept.html>Propag&#xE1;cia alternat&#xED;vnej medic&#xED;ny</a><li><a href=/VotrelciDavnoveku.html>Votrelci d&#xE1;vnoveku</a><li><a href=/GeneralAll.html>&#8230;</a></ul></div></div></div><div class=well><h4>O mne</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/VyvojarskeOdkazy.html>Moje vyvojarske blogy</a><li><a href=/OMne.html>O mne</a><li><a href=/OMneOdkazy.html>Moja tvorba inde</a><li><a href=/Portfolio.html>Portólio</a></ul></div></div></div></div></div><hr><footer><div class="row no-print"><div class="col-lg-8 col-sm-8"><div class=well><h4>Našli ste chybu, alebo chcete niečo doplniť?</h4><p>Ak ste našli chybu v článu, chcete niečo dopniť, alebo sa vyjadriť k téme, môžete na <a href="https://github.com/harrison314/harrison314.github.io/issues/new?title=MongoDB%20vs.%20RavenDB&amp;body=https%3A%2F%2Fharrison314.github.io%2FMongoDbVsRavenDb.html" target=_blank>Githube otvoriť issue</a>.</div></div></div><div class=row><div class=col-lg-12><p>Copyright &copy; harrison314 2013<span class=on-print> - https://harrison314.github.io/</span></div></div></footer></div><script src=js/jquery.js></script><script src=js/bootstrap.min.js></script>