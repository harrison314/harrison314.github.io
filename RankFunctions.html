<!DOCTYPE html><html lang=sk><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=X-Xss-Protection content="1; mode=block"><meta http-equiv=X-Content-Type-Options content=nosniff><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="RSS Feed" href=/feed.rss><link rel=alternate type=application/atom+xml title="Atom Feed" href=/feed.atom><meta name=author content=harrison314><title>MS SQL a RANK funkcie</title><meta property=og:title content="MS SQL a RANK funkcie"><meta property=og:description content="Ukážka RANK a Windows funkcii v MS SQL (SQL Serveru)."><meta property=og:url content=https://harrison314.github.io/RankFunctions.html><meta name=description content="Ukážka RANK a Windows funkcii v MS SQL (SQL Serveru)."><link href=css/bootstrap.min.css rel=stylesheet><link href=css/blog-post.css rel=stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><link rel=stylesheet href=css/Highiler/vs.css><style>img{max-width:100%}.img-center{display:block;margin-left:auto;margin-right:auto}</style><body><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=index.html>harrison314 blog</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href=/All.html>Obsah</a><li><a href=/DevelopingAll.html>Programovanie</a><li><a href=/GeneralAll.html>Všeobecné</a><li><a href=/OMne.html>O mne</a></ul></div></div></nav><div class=container><div class=row><div class="col-lg-8 col-md-8"><h1>MS SQL a RANK funkcie</h1><div class=publishDate>Október 2022</div><p>V SQL rank funkcie umožňujú učiť poradie v&nbsp;dopyte podľa nejakého kritéria. Táto funkcia je veľmi užitočná pri&nbsp;istom type dopytov. V&nbsp;tomto blogu píšem aj&nbsp;o iných maličkostiach, uľahčujúcich život. No&nbsp;nejde o&nbsp;žiadne novinky, plno týchto funkcionalít je dostupný od&nbsp;<em>SQL Serveru 2008 R2</em>.<h2 id=prikladovy-problem>Príkladový problém</h2><p>Keď som ešte&nbsp;pracoval s&nbsp;PHP a&nbsp;MySQL na&nbsp;sociálnej sieti pre&nbsp;lukostrelcov, tak som dostal úlohu, zobraziť v&nbsp;detaile luku (produktu) najlepšie výsledky, ktoré tým lukom boli dosiahnuté v&nbsp;jednotlivých kategóriách súťaží, kde&nbsp;boli použité.<p>Šlo to spraviť selfjoinom a&nbsp;vnoreným dopytom, no&nbsp;to MySQL zabilo, doslova, pri&nbsp;tabuľke s&nbsp;dvoma tisíckami záznamov vyletel procesor na&nbsp;100% a&nbsp;po troch minútach MySQL zamrzla a&nbsp;bolo potrebné ju celú reštartovať. Riešením bolo nakoniec použiť <em>N+1 dopytov</em> – najskôr sa vytiahol zoznam kategórií a&nbsp;potom sa pre&nbsp;každú vytiahli najlepšie výsledky so&nbsp;súťažou a&nbsp;súťažiacim.<p>Presne na&nbsp;takýto scenár ide požiť funkcia <a href="https://learn.microsoft.com/en-us/sql/t-sql/functions/rank-transact-sql?view=sql-server-ver16">RANK</a> (<a href="https://learn.microsoft.com/en-us/sql/t-sql/functions/dense-rank-transact-sql?view=sql-server-ver16">DENSE_RANK</a>) v&nbsp;MS SQL.<p>Nasledujúci kód vytvorí testovaciu databázu, nad ktorou ukážem riešenie podobného problému ako vyššie a&nbsp;tiež použitie window funkcií.<pre><code class="language-sql hljs"><span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>TABLE</span> [dbo].[Competition](
	[<span class=hljs-keyword>Id</span>] [<span class=hljs-built_in>int</span>] <span class=hljs-keyword>IDENTITY</span>(<span class=hljs-number>1</span>,<span class=hljs-number>1</span>) <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[<span class=hljs-keyword>Name</span>] [<span class=hljs-keyword>nvarchar</span>](<span class=hljs-number>500</span>) <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
 <span class=hljs-keyword>CONSTRAINT</span> [PK_Competition] PRIMARY <span class=hljs-keyword>KEY</span> CLUSTERED 
(
	[<span class=hljs-keyword>Id</span>] <span class=hljs-keyword>ASC</span>
)<span class=hljs-keyword>WITH</span> (PAD_INDEX = <span class=hljs-keyword>OFF</span>, STATISTICS_NORECOMPUTE = <span class=hljs-keyword>OFF</span>, IGNORE_DUP_KEY = <span class=hljs-keyword>OFF</span>, ALLOW_ROW_LOCKS = <span class=hljs-keyword>ON</span>, ALLOW_PAGE_LOCKS = <span class=hljs-keyword>ON</span>) <span class=hljs-keyword>ON</span> [PRIMARY]
) <span class=hljs-keyword>ON</span> [PRIMARY]
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>TABLE</span> [dbo].[Competition_CompetitionCathegory](
	[CompetitionId] [<span class=hljs-built_in>int</span>] <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[CompetitionCathegoryId] [<span class=hljs-built_in>int</span>] <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
 <span class=hljs-keyword>CONSTRAINT</span> [PK_Competition_CompetitionCathegory] PRIMARY <span class=hljs-keyword>KEY</span> CLUSTERED 
(
	[CompetitionId] <span class=hljs-keyword>ASC</span>,
	[CompetitionCathegoryId] <span class=hljs-keyword>ASC</span>
)<span class=hljs-keyword>WITH</span> (PAD_INDEX = <span class=hljs-keyword>OFF</span>, STATISTICS_NORECOMPUTE = <span class=hljs-keyword>OFF</span>, IGNORE_DUP_KEY = <span class=hljs-keyword>OFF</span>, ALLOW_ROW_LOCKS = <span class=hljs-keyword>ON</span>, ALLOW_PAGE_LOCKS = <span class=hljs-keyword>ON</span>) <span class=hljs-keyword>ON</span> [PRIMARY]
) <span class=hljs-keyword>ON</span> [PRIMARY]
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>TABLE</span> [dbo].[CompetitionCategory](
	[<span class=hljs-keyword>Id</span>] [<span class=hljs-built_in>int</span>] <span class=hljs-keyword>IDENTITY</span>(<span class=hljs-number>1</span>,<span class=hljs-number>1</span>) <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[<span class=hljs-keyword>Name</span>] [<span class=hljs-keyword>nvarchar</span>](<span class=hljs-number>50</span>) <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
 <span class=hljs-keyword>CONSTRAINT</span> [PK_CompetitionCategory] PRIMARY <span class=hljs-keyword>KEY</span> CLUSTERED 
(
	[<span class=hljs-keyword>Id</span>] <span class=hljs-keyword>ASC</span>
)<span class=hljs-keyword>WITH</span> (PAD_INDEX = <span class=hljs-keyword>OFF</span>, STATISTICS_NORECOMPUTE = <span class=hljs-keyword>OFF</span>, IGNORE_DUP_KEY = <span class=hljs-keyword>OFF</span>, ALLOW_ROW_LOCKS = <span class=hljs-keyword>ON</span>, ALLOW_PAGE_LOCKS = <span class=hljs-keyword>ON</span>) <span class=hljs-keyword>ON</span> [PRIMARY]
) <span class=hljs-keyword>ON</span> [PRIMARY]
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>TABLE</span> [dbo].[CompetitionResult](
	[<span class=hljs-keyword>Id</span>] [<span class=hljs-built_in>int</span>] <span class=hljs-keyword>IDENTITY</span>(<span class=hljs-number>1</span>,<span class=hljs-number>1</span>) <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[UserId] [<span class=hljs-built_in>int</span>] <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[CompetitionId] [<span class=hljs-built_in>int</span>] <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[CathegoryId] [<span class=hljs-built_in>int</span>] <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[Points] [<span class=hljs-built_in>int</span>] <span class=hljs-literal>NULL</span>,
	[Notes] [<span class=hljs-keyword>nvarchar</span>](<span class=hljs-number>500</span>) <span class=hljs-literal>NULL</span>,
 <span class=hljs-keyword>CONSTRAINT</span> [PK_CompetitionResult] PRIMARY <span class=hljs-keyword>KEY</span> CLUSTERED 
(
	[<span class=hljs-keyword>Id</span>] <span class=hljs-keyword>ASC</span>
)<span class=hljs-keyword>WITH</span> (PAD_INDEX = <span class=hljs-keyword>OFF</span>, STATISTICS_NORECOMPUTE = <span class=hljs-keyword>OFF</span>, IGNORE_DUP_KEY = <span class=hljs-keyword>OFF</span>, ALLOW_ROW_LOCKS = <span class=hljs-keyword>ON</span>, ALLOW_PAGE_LOCKS = <span class=hljs-keyword>ON</span>) <span class=hljs-keyword>ON</span> [PRIMARY]
) <span class=hljs-keyword>ON</span> [PRIMARY]
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>TABLE</span> [dbo].[<span class=hljs-keyword>User</span>](
	[<span class=hljs-keyword>Id</span>] [<span class=hljs-built_in>int</span>] <span class=hljs-keyword>IDENTITY</span>(<span class=hljs-number>1</span>,<span class=hljs-number>1</span>) <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[<span class=hljs-keyword>Name</span>] [<span class=hljs-keyword>nvarchar</span>](<span class=hljs-number>50</span>) <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[Gender] [<span class=hljs-built_in>bit</span>] <span class=hljs-literal>NULL</span>,
 <span class=hljs-keyword>CONSTRAINT</span> [PK_User] PRIMARY <span class=hljs-keyword>KEY</span> CLUSTERED 
(
	[<span class=hljs-keyword>Id</span>] <span class=hljs-keyword>ASC</span>
)<span class=hljs-keyword>WITH</span> (PAD_INDEX = <span class=hljs-keyword>OFF</span>, STATISTICS_NORECOMPUTE = <span class=hljs-keyword>OFF</span>, IGNORE_DUP_KEY = <span class=hljs-keyword>OFF</span>, ALLOW_ROW_LOCKS = <span class=hljs-keyword>ON</span>, ALLOW_PAGE_LOCKS = <span class=hljs-keyword>ON</span>) <span class=hljs-keyword>ON</span> [PRIMARY]
) <span class=hljs-keyword>ON</span> [PRIMARY]
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[Competition_CompetitionCathegory]  <span class=hljs-keyword>WITH</span> <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>ADD</span>  <span class=hljs-keyword>CONSTRAINT</span> [FK_Competition_CompetitionCathegory_Competition] FOREIGN <span class=hljs-keyword>KEY</span>([CompetitionId])
<span class=hljs-keyword>REFERENCES</span> [dbo].[Competition] ([<span class=hljs-keyword>Id</span>])
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[Competition_CompetitionCathegory] <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>CONSTRAINT</span> [FK_Competition_CompetitionCathegory_Competition]
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[Competition_CompetitionCathegory]  <span class=hljs-keyword>WITH</span> <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>ADD</span>  <span class=hljs-keyword>CONSTRAINT</span> [FK_Competition_CompetitionCathegory_CompetitionCategory] FOREIGN <span class=hljs-keyword>KEY</span>([CompetitionCathegoryId])
<span class=hljs-keyword>REFERENCES</span> [dbo].[CompetitionCategory] ([<span class=hljs-keyword>Id</span>])
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[Competition_CompetitionCathegory] <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>CONSTRAINT</span> [FK_Competition_CompetitionCathegory_CompetitionCategory]
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[CompetitionResult]  <span class=hljs-keyword>WITH</span> <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>ADD</span>  <span class=hljs-keyword>CONSTRAINT</span> [FK_CompetitionResult_Competition] FOREIGN <span class=hljs-keyword>KEY</span>([CompetitionId])
<span class=hljs-keyword>REFERENCES</span> [dbo].[Competition] ([<span class=hljs-keyword>Id</span>])
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[CompetitionResult] <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>CONSTRAINT</span> [FK_CompetitionResult_Competition]
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[CompetitionResult]  <span class=hljs-keyword>WITH</span> <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>ADD</span>  <span class=hljs-keyword>CONSTRAINT</span> [FK_CompetitionResult_CompetitionCategory] FOREIGN <span class=hljs-keyword>KEY</span>([CathegoryId])
<span class=hljs-keyword>REFERENCES</span> [dbo].[CompetitionCategory] ([<span class=hljs-keyword>Id</span>])
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[CompetitionResult] <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>CONSTRAINT</span> [FK_CompetitionResult_CompetitionCategory]
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[CompetitionResult]  <span class=hljs-keyword>WITH</span> <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>ADD</span>  <span class=hljs-keyword>CONSTRAINT</span> [FK_CompetitionResult_User] FOREIGN <span class=hljs-keyword>KEY</span>([UserId])
<span class=hljs-keyword>REFERENCES</span> [dbo].[<span class=hljs-keyword>User</span>] ([<span class=hljs-keyword>Id</span>])
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>ALTER</span> <span class=hljs-keyword>TABLE</span> [dbo].[CompetitionResult] <span class=hljs-keyword>CHECK</span> <span class=hljs-keyword>CONSTRAINT</span> [FK_CompetitionResult_User]
<span class=hljs-keyword>GO</span>

<span class=hljs-keyword>SET</span> IDENTITY_INSERT [dbo].[CompetitionCategory] <span class=hljs-keyword>ON</span>
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>INSERT</span> [dbo].[CompetitionCategory] ([<span class=hljs-keyword>Id</span>], [<span class=hljs-keyword>Name</span>]) <span class=hljs-keyword>VALUES</span> (<span class=hljs-number>1</span>, N<span class=hljs-string>'Bowhunter Freestyle Limited'</span>), (<span class=hljs-number>2</span>, N<span class=hljs-string>'Barebow'</span>), (<span class=hljs-number>3</span>, N<span class=hljs-string>'Freestyle Limited'</span>),
(<span class=hljs-number>4</span>, N<span class=hljs-string>'Traditional'</span>), (<span class=hljs-number>5</span>, N<span class=hljs-string>'NFAA'</span>), (<span class=hljs-number>6</span>, N<span class=hljs-string>'Indoor'</span>)
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>SET</span> IDENTITY_INSERT [dbo].[CompetitionCategory] <span class=hljs-keyword>OFF</span>
<span class=hljs-keyword>GO</span>

<span class=hljs-keyword>SET</span> IDENTITY_INSERT [dbo].[Competition] <span class=hljs-keyword>ON</span> 
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>INSERT</span> [dbo].[Competition] ([<span class=hljs-keyword>Id</span>], [<span class=hljs-keyword>Name</span>]) <span class=hljs-keyword>VALUES</span> (<span class=hljs-number>1</span>, N<span class=hljs-string>'Minnehaha Archers Summer Field League - Week 5'</span>),
(<span class=hljs-number>2</span>, N<span class=hljs-string>'Face2Face'</span>),
(<span class=hljs-number>3</span>, N<span class=hljs-string>'Minnehaha Archers Summer Field League - Week 7'</span>)
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>SET</span> IDENTITY_INSERT [dbo].[Competition] <span class=hljs-keyword>OFF</span>
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>INSERT</span> [dbo].[Competition_CompetitionCathegory] ([CompetitionId], [CompetitionCathegoryId]) <span class=hljs-keyword>VALUES</span> (<span class=hljs-number>1</span>, <span class=hljs-number>1</span>),(<span class=hljs-number>1</span>, <span class=hljs-number>2</span>),(<span class=hljs-number>1</span>, <span class=hljs-number>3</span>),(<span class=hljs-number>2</span>, <span class=hljs-number>2</span>),(<span class=hljs-number>2</span>, <span class=hljs-number>3</span>),(<span class=hljs-number>2</span>, <span class=hljs-number>4</span>),(<span class=hljs-number>3</span>, <span class=hljs-number>5</span>),(<span class=hljs-number>3</span>, <span class=hljs-number>6</span>)
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>SET</span> IDENTITY_INSERT [dbo].[<span class=hljs-keyword>User</span>] <span class=hljs-keyword>ON</span> 
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>INSERT</span> [dbo].[<span class=hljs-keyword>User</span>] ([<span class=hljs-keyword>Id</span>], [<span class=hljs-keyword>Name</span>], [Gender]) <span class=hljs-keyword>VALUES</span> (<span class=hljs-number>1</span>, N<span class=hljs-string>'Lena'</span>, <span class=hljs-number>0</span>),
(<span class=hljs-number>2</span>, N<span class=hljs-string>'Jano'</span>, <span class=hljs-number>1</span>),(<span class=hljs-number>3</span>, N<span class=hljs-string>'Dano'</span>, <span class=hljs-number>1</span>),(<span class=hljs-number>4</span>, N<span class=hljs-string>'Marianna'</span>, <span class=hljs-number>0</span>),
(<span class=hljs-number>5</span>, N<span class=hljs-string>'Greta'</span>, <span class=hljs-number>0</span>),(<span class=hljs-number>6</span>, N<span class=hljs-string>'Ada'</span>, <span class=hljs-number>0</span>),
(<span class=hljs-number>7</span>, N<span class=hljs-string>'Mirka'</span>, <span class=hljs-number>0</span>),(<span class=hljs-number>8</span>, N<span class=hljs-string>'Peter'</span>, <span class=hljs-number>1</span>),
(<span class=hljs-number>9</span>, N<span class=hljs-string>'Martin'</span>, <span class=hljs-number>1</span>),(<span class=hljs-number>10</span>, N<span class=hljs-string>'Martin G.'</span>, <span class=hljs-number>1</span>),
(<span class=hljs-number>11</span>, N<span class=hljs-string>'Maria'</span>, <span class=hljs-number>0</span>),(<span class=hljs-number>12</span>, N<span class=hljs-string>'Silvester'</span>, <span class=hljs-number>1</span>)
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>SET</span> IDENTITY_INSERT [dbo].[<span class=hljs-keyword>User</span>] <span class=hljs-keyword>OFF</span>
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>SET</span> IDENTITY_INSERT [dbo].[CompetitionResult] <span class=hljs-keyword>ON</span>
<span class=hljs-keyword>INSERT</span> [dbo].[CompetitionResult] ([<span class=hljs-keyword>Id</span>], [UserId], [CompetitionId], [CathegoryId], [Points], [Notes]) <span class=hljs-keyword>VALUES</span> (<span class=hljs-number>1</span>, <span class=hljs-number>1</span>, <span class=hljs-number>1</span>, <span class=hljs-number>1</span>, <span class=hljs-number>256</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>2</span>, <span class=hljs-number>2</span>, <span class=hljs-number>1</span>, <span class=hljs-number>1</span>, <span class=hljs-number>120</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>3</span>, <span class=hljs-number>3</span>, <span class=hljs-number>1</span>, <span class=hljs-number>1</span>, <span class=hljs-number>1500</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>4</span>, <span class=hljs-number>4</span>, <span class=hljs-number>1</span>, <span class=hljs-number>2</span>, <span class=hljs-number>41</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>5</span>, <span class=hljs-number>2</span>, <span class=hljs-number>1</span>, <span class=hljs-number>2</span>, <span class=hljs-number>24</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>6</span>, <span class=hljs-number>5</span>, <span class=hljs-number>1</span>, <span class=hljs-number>2</span>, <span class=hljs-number>24</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>7</span>, <span class=hljs-number>1</span>, <span class=hljs-number>1</span>, <span class=hljs-number>2</span>, <span class=hljs-number>0</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>8</span>, <span class=hljs-number>6</span>, <span class=hljs-number>1</span>, <span class=hljs-number>2</span>, <span class=hljs-number>15</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>9</span>, <span class=hljs-number>2</span>, <span class=hljs-number>1</span>, <span class=hljs-number>3</span>, <span class=hljs-number>120</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>10</span>, <span class=hljs-number>3</span>, <span class=hljs-number>1</span>, <span class=hljs-number>3</span>, <span class=hljs-number>110</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>11</span>, <span class=hljs-number>6</span>, <span class=hljs-number>1</span>, <span class=hljs-number>4</span>, <span class=hljs-number>130</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>12</span>, <span class=hljs-number>7</span>, <span class=hljs-number>2</span>, <span class=hljs-number>4</span>, <span class=hljs-number>80</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>13</span>, <span class=hljs-number>8</span>, <span class=hljs-number>2</span>, <span class=hljs-number>4</span>, <span class=hljs-number>114</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>14</span>, <span class=hljs-number>7</span>, <span class=hljs-number>2</span>, <span class=hljs-number>2</span>, <span class=hljs-number>85</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>15</span>, <span class=hljs-number>9</span>, <span class=hljs-number>2</span>, <span class=hljs-number>2</span>, <span class=hljs-number>91</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>16</span>, <span class=hljs-number>10</span>, <span class=hljs-number>2</span>, <span class=hljs-number>2</span>, <span class=hljs-number>42</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>17</span>, <span class=hljs-number>12</span>, <span class=hljs-number>2</span>, <span class=hljs-number>2</span>, <span class=hljs-number>91</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>18</span>, <span class=hljs-number>6</span>, <span class=hljs-number>2</span>, <span class=hljs-number>3</span>, <span class=hljs-number>174</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>19</span>, <span class=hljs-number>7</span>, <span class=hljs-number>2</span>, <span class=hljs-number>3</span>, <span class=hljs-number>200</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>20</span>, <span class=hljs-number>8</span>, <span class=hljs-number>2</span>, <span class=hljs-number>3</span>, <span class=hljs-number>195</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>21</span>, <span class=hljs-number>9</span>, <span class=hljs-number>2</span>, <span class=hljs-number>3</span>, <span class=hljs-number>112</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>22</span>, <span class=hljs-number>10</span>, <span class=hljs-number>2</span>, <span class=hljs-number>3</span>, <span class=hljs-number>45</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>23</span>, <span class=hljs-number>11</span>, <span class=hljs-number>2</span>, <span class=hljs-number>3</span>, <span class=hljs-number>138</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>24</span>, <span class=hljs-number>12</span>, <span class=hljs-number>2</span>, <span class=hljs-number>3</span>, <span class=hljs-number>0</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>25</span>, <span class=hljs-number>7</span>, <span class=hljs-number>3</span>, <span class=hljs-number>5</span>, <span class=hljs-number>47</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>26</span>, <span class=hljs-number>8</span>, <span class=hljs-number>3</span>, <span class=hljs-number>5</span>, <span class=hljs-number>39</span>, <span class=hljs-literal>NULL</span>),
(<span class=hljs-number>27</span>, <span class=hljs-number>1</span>, <span class=hljs-number>3</span>, <span class=hljs-number>6</span>, <span class=hljs-number>266</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>28</span>, <span class=hljs-number>2</span>, <span class=hljs-number>3</span>, <span class=hljs-number>6</span>, <span class=hljs-number>200</span>, <span class=hljs-literal>NULL</span>),(<span class=hljs-number>29</span>, <span class=hljs-number>3</span>, <span class=hljs-number>3</span>, <span class=hljs-number>6</span>, <span class=hljs-number>1101</span>, <span class=hljs-literal>NULL</span>)
<span class=hljs-keyword>GO</span>
<span class=hljs-keyword>SET</span> IDENTITY_INSERT [dbo].[CompetitionResult] <span class=hljs-keyword>OFF</span>
<span class=hljs-keyword>GO</span>
</code></pre><p>Pre vytiahnutntie súťažiacich, ktorý&nbsp;dosiahli najviac bodov v&nbsp;danej kategórii ide použiť nasledujúce SQL.<p>Je v&nbsp;ňom využité <em>CTE</em> a&nbsp;funkcia <a href="https://learn.microsoft.com/en-us/sql/t-sql/functions/dense-rank-transact-sql?view=sql-server-ver16">DENSE_RANK</a>, ktorá očísluje riadky podľa počtu bodov pre&nbsp;konkrétnu kategóriu. Následne je vonkajšou podmienkou zabezpečené aby&nbsp;sa vybrali len najlepšie výsledky.<p>Toto SQL je jednoduché upraviť tak, aby&nbsp;vracalo <em>N</em> najlepších výsledkov pomocou úpravy <em>WHERE</em> klauzuly.<pre><code class="language-sql hljs">WITH RankedPoints ([UserName], [Competition], [Cathegory], [Points], [Rank])
AS
(
 <span class=hljs-keyword>SELECT</span> [u].[<span class=hljs-keyword>Name</span>] <span class=hljs-keyword>AS</span> [UserName],
        [c].[<span class=hljs-keyword>Name</span>] <span class=hljs-keyword>AS</span> [Competition],
        [cc].[<span class=hljs-keyword>Name</span>] <span class=hljs-keyword>AS</span> [Cathegory],
        [cr].[Points] <span class=hljs-keyword>AS</span> [Points],
	    <span class=hljs-keyword>DENSE_RANK</span>() <span class=hljs-keyword>OVER</span> (<span class=hljs-keyword>PARTITION</span> <span class=hljs-keyword>BY</span> [cr].[CathegoryId] <span class=hljs-keyword>ORDER</span> <span class=hljs-keyword>BY</span> [cr].[Points] <span class=hljs-keyword>DESC</span>) <span class=hljs-keyword>AS</span> [<span class=hljs-keyword>Rank</span>]
  <span class=hljs-keyword>FROM</span> [dbo].[CompetitionResult] [cr]
  <span class=hljs-keyword>LEFT</span> <span class=hljs-keyword>JOIN</span> [dbo].[<span class=hljs-keyword>User</span>] [u] <span class=hljs-keyword>ON</span> [cr].[UserId] = [u].[<span class=hljs-keyword>Id</span>]
  <span class=hljs-keyword>LEFT</span> <span class=hljs-keyword>JOIN</span> [dbo].[Competition] [c] <span class=hljs-keyword>ON</span> [cr].[CompetitionId] = [c].[<span class=hljs-keyword>Id</span>]
  <span class=hljs-keyword>LEFT</span> <span class=hljs-keyword>JOIN</span> [dbo].[CompetitionCategory] [cc] <span class=hljs-keyword>ON</span> [cr].[CathegoryId] = [cc].[<span class=hljs-keyword>Id</span>]
)
<span class=hljs-keyword>SELECT</span> [UserName], [Competition], [Cathegory], [Points] <span class=hljs-keyword>FROM</span> RankedPoints
<span class=hljs-keyword>WHERE</span> [<span class=hljs-keyword>Rank</span>] = <span class=hljs-number>1</span>
</code></pre><h2 id=ine-triky>Iné triky</h2><p>Window funkcie umožňujú „naporcovať“ skúmané dáta podobne ako pri&nbsp;grupovaní, ale&nbsp;týmto spôsobom je možné vytiahnuť aj&nbsp;iné údaje v&nbsp;riadkoch a&nbsp;„porcoať“ ich podľa rôznych kritérií.<p>Nasledujúci selekt vráti medián bodov a&nbsp;počet súťažiacich pre&nbsp;kategórie. Window funkcie sa zvyčajne používajú s&nbsp;<code>DISTINCT</code> kvôli opakujúcim sa riadkom vo výsledkoch.<pre><code class="language-sql hljs"><span class=hljs-keyword>SELECT</span> <span class=hljs-keyword>DISTINCT</span> [cc].[<span class=hljs-keyword>Name</span>] <span class=hljs-keyword>AS</span> [Cathegory],
		<span class=hljs-keyword>PERCENTILE_CONT</span>(<span class=hljs-number>0.5</span>) <span class=hljs-keyword>WITHIN</span> <span class=hljs-keyword>GROUP</span> (<span class=hljs-keyword>ORDER</span> <span class=hljs-keyword>BY</span>  [Points]) <span class=hljs-keyword>OVER</span> (<span class=hljs-keyword>PARTITION</span> <span class=hljs-keyword>BY</span> [cr].[CathegoryId]) <span class=hljs-keyword>AS</span> [PointsMedian],
		<span class=hljs-keyword>COUNT</span>([cr].[UserId]) <span class=hljs-keyword>OVER</span> (<span class=hljs-keyword>PARTITION</span> <span class=hljs-keyword>BY</span> [cr].[CathegoryId]) <span class=hljs-keyword>AS</span> [<span class=hljs-keyword>Count</span>]
  <span class=hljs-keyword>FROM</span> [dbo].[CompetitionResult] [cr]
  <span class=hljs-keyword>LEFT</span> <span class=hljs-keyword>JOIN</span> [dbo].[<span class=hljs-keyword>User</span>] [u] <span class=hljs-keyword>ON</span> [cr].[UserId] = [u].[<span class=hljs-keyword>Id</span>]
  <span class=hljs-keyword>LEFT</span> <span class=hljs-keyword>JOIN</span> [dbo].[CompetitionCategory] [cc] <span class=hljs-keyword>ON</span> [cr].[CathegoryId] = [cc].[<span class=hljs-keyword>Id</span>]
</code></pre><p>Do agregačných funkcií idú vpísať podmienky, to sa dá využiť pri&nbsp;rôznom spočítavaní. Napríklad nasledujúci dopyt vráti počet súťažiacich mužov a&nbsp;žien v&nbsp;kategóriách:<pre><code class="language-sql hljs"><span class=hljs-keyword>SELECT</span> [cc].[<span class=hljs-keyword>Name</span>] <span class=hljs-keyword>AS</span> [Cathegory],
	   <span class=hljs-keyword>COUNT</span>(*) <span class=hljs-keyword>AS</span> [Total],
	   <span class=hljs-keyword>SUM</span>(<span class=hljs-keyword>IIF</span>([u].[Gender] = <span class=hljs-number>1</span>, <span class=hljs-number>1</span>, <span class=hljs-number>0</span>)) <span class=hljs-keyword>AS</span> [Men],
	   <span class=hljs-keyword>SUM</span>(<span class=hljs-keyword>IIF</span>([u].[Gender] = <span class=hljs-number>0</span>, <span class=hljs-number>1</span>, <span class=hljs-number>0</span>)) <span class=hljs-keyword>AS</span> [Women]
  <span class=hljs-keyword>FROM</span> [dbo].[CompetitionResult] [cr]
  <span class=hljs-keyword>LEFT</span> <span class=hljs-keyword>JOIN</span> [dbo].[<span class=hljs-keyword>User</span>] [u] <span class=hljs-keyword>ON</span> [cr].[UserId] = [u].[<span class=hljs-keyword>Id</span>]
  <span class=hljs-keyword>LEFT</span> <span class=hljs-keyword>JOIN</span> [dbo].[CompetitionCategory] [cc] <span class=hljs-keyword>ON</span> [cr].[CathegoryId] = [cc].[<span class=hljs-keyword>Id</span>]
  <span class=hljs-keyword>GROUP</span> <span class=hljs-keyword>BY</span> [cr].[CathegoryId], [cc].[<span class=hljs-keyword>Name</span>]
</code></pre><h2 id=zaver>Záver</h2><p>Tento blog nemal za&nbsp;cieľ byť úplným a&nbsp;a vyčerpávajúcim, skôr šlo ukázať niektoré málo známe možnosti.</div><div class="col-lg-4 col-md-4 hidden-xs hidden-sm"><div class=well><h4>Vývoj</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/RankFunctions.html>MS SQL a RANK funkcie</a><li><a href=/MongoDbVsRavenDb.html>MongoDB vs. RavenDB</a><li><a href=/WinHttp.html>Použitie WinHTTP</a><li><a href=/BinaryContentInApi.html>ASP.NET Core API a binárny obsah</a><li><a href=/PerformaceInNet.html>Meranie performace pre dotnetistov</a><li><a href=/CngApiTips.html>Triky s Windows CNG API</a><li><a href=/InMemoryOltp.html>Experiment s In-Memory OLTP</a><li><a href=/CoMaNauciloIot.html>Čo ma naučilo IoT</a><li><a href=/SkEid.html>eID nie je platobná karta</a><li><a href=/eVolby.html>Elektronické voľby</a><li><a href=/DevelopingAll.html>…</a></ul></div></div></div><div class=well><h4>Všeobecné</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/EzoGenerator.html>Generátor Ezo textov</a><li><a href=/AlternativnyRecept.html>Propagácia alternatívnej medicíny</a><li><a href=/VotrelciDavnoveku.html>Votrelci dávnoveku</a><li><a href=/GeneralAll.html>…</a></ul></div></div></div><div class=well><h4>O mne</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/VyvojarskeOdkazy.html>Moje vyvojarske blogy</a><li><a href=/OMne.html>O mne</a><li><a href=/OMneOdkazy.html>Moja tvorba inde</a><li><a href=/Portfolio.html>Portólio</a></ul></div></div></div></div></div><hr><footer><div class=row><div class="col-lg-8 col-sm-8"><div class=well><h4>Našli ste chybu, alebo chcete niečo doplniť?</h4><p>Ak ste našli chybu v článu, chcete niečo dopniť, alebo sa vyjadriť k téme, môžete na <a href="https://github.com/harrison314/harrison314.github.io/issues/new?title=MS%20SQL%20a%20RANK%20funkcie&amp;body=https%3A%2F%2Fharrison314.github.io%2FRankFunctions.html" target=_blank>Githube otvoriť issue</a>.</div></div></div><div class=row><div class=col-lg-12><p>Copyright © harrison314 2013</div></div></footer></div><script src=js/jquery.js></script><script src=js/bootstrap.min.js></script>