<!DOCTYPE html><html lang=sk><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta http-equiv=X-Xss-Protection content="1; mode=block"><meta http-equiv=X-Content-Type-Options content=nosniff><meta name=viewport content="width=device-width, initial-scale=1"><link rel=alternate type=application/rss+xml title="RSS Feed" href=/feed.rss><link rel=alternate type=application/atom+xml title="Atom Feed" href=/feed.atom><meta name=author content=harrison314><title>Experiment s In-Memory OLTP</title><meta property=og:title content="Experiment s In-Memory OLTP"><meta property=og:description content="Myšlienkový a praktický experiment, ako riešiť systém na registráciu termínov, ktorá odolá veľkej záťaži."><meta property=og:url content=https://harrison314.github.io/InMemoryOltp.html><meta property=og:image content=https://harrison314.github.io/images/InMemoryOltp/InMemorytable.png><meta name=description content="Myšlienkový a praktický experiment, ako riešiť systém na registráciu termínov, ktorá odolá veľkej záťaži."><link href=css/bootstrap.min.css rel=stylesheet><link href=css/blog-post.css rel=stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js></script><script src=https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js></script><![endif]--><link rel=stylesheet href=css/Highiler/vs.css><style>img{max-width:100%}.img-center{display:block;margin-left:auto;margin-right:auto}</style><body><nav class="navbar navbar-inverse navbar-fixed-top" role=navigation><div class=container><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#bs-example-navbar-collapse-1> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=index.html>harrison314 blog</a></div><div class="collapse navbar-collapse" id=bs-example-navbar-collapse-1><ul class="nav navbar-nav"><li><a href=/All.html>Obsah</a><li><a href=/DevelopingAll.html>Programovanie</a><li><a href=/GeneralAll.html>Všeobecné</a><li><a href=/OMne.html>O mne</a></ul></div></div></nav><div class=container><div class=row><div class="col-lg-8 col-md-8"><h1>Experiment s In-Memory OLTP pre high performance registráciu</h1><div class=publishDate>Január 2021</div><p>Po preťažení niektorých informačných systémov v&nbsp;súvislosti s&nbsp;Covid testami a&nbsp;očkovaním som si skúsil najskôr myšlienkový a&nbsp;neskôr aj&nbsp;praktický experiment. Rozmýšľal som, ako navrhnúť systém na&nbsp;registráciu termínov, ktorý&nbsp;odolá veľkej (nárazovej) záťaži. Ďalšími podmienkami bolo aby&nbsp;bol systém spoľahlivý (transakčnosť registrácie) a&nbsp;citlivé dáta neukladal niekde, kde&nbsp;by nemali byť. Po&nbsp;preskúmaní rôznych možností a&nbsp;databáz som sa to pokúsil vyriešiť pomocou technológie <em>In-Memory OLTP</em> v&nbsp;<em>MS SQL</em>.<h2 id=inspiracia>Inšpirácia</h2><p>17.1.2012 bol na&nbsp;Slovensku preťažený systém na&nbsp;objednávanie sa na&nbsp;antigénové testy. Preťaženie vyvolala okamžitá reakcia ľudí na&nbsp;tlačovú konferenciu o&nbsp;celoplošnom skríningu (viac <a href="https://zive.aktuality.sk/clanok/150616/skrining-objednanie-antigenove-testy-testovanie-termin/">tu</a>). V&nbsp;Česku mali podobné problémy zo&nbsp;systémom na&nbsp;registráciu očkovania (<a href=https://twitter.com/ChytraKarantena/status/1349983604571582466>problémy s&nbsp;Chytrou karanténou</a>).<p>Nechcem tu rozoberať problémy štátneho IT (zhrnutie je možné pozrieť si <a href=https://tech.ihned.cz/c7-66870010-psms7-e882c2115d7c68a>tu</a>). No&nbsp;je jasné, že&nbsp;ak službu dizajnujete pre&nbsp;stovky až tisíce aktívnych používateľov a&nbsp;zrazu sa ich tam nahrnie 150-ktát viac, tak to proste padne. Jednou z&nbsp;chýb bolo to, že&nbsp;NCZI na&nbsp;danú situáciu nebolo ani&nbsp;len upozornené a&nbsp;nemalo čas zareagovať. Toto sa nestáva len v&nbsp;štátnom IT. Niečo podobné sa stalo len pár dní predtým <em>Signalu</em>. Aplikácia <em>WatsApp</em> zmenila podmienky používania a&nbsp;ochrany súkromia, čo&nbsp;spôsobilo odliv používateľov k&nbsp;<em>Signalu</em> a&nbsp;spôsobili mu <a href="https://zive.aktuality.sk/clanok/150597/signal-mal-v-noci-velky-vypadok-problemy-mozu-pretrvavat/">výpadky</a>.<p>Následne som v&nbsp;diskusiách a&nbsp;článkoch na&nbsp;internete hľadal, ako tento problém vyriešiť – <strong>ako nadizajnosvať systém, aby&nbsp;vydržal aj&nbsp;veľkú nárazovú záťaž, pričom používatelia systému sa bijú o&nbsp;obmedzené zdieľané prostriedky</strong> (termíny na&nbsp;očkovanie alebo&nbsp;Ag. testy).<p>Podstatnú časť odpovedí tvorilo <em>„dať to do&nbsp;cloudu“</em>. Áno sila desiatok serverov znesie veľa, no&nbsp;jestvujú dosť pádne dôvody, prečo štát nedáva citlivé zdravotnícke dáta na&nbsp;počítače niekoho iného a&nbsp;k tomu v&nbsp;jurisdikcii iného štátu. Plno ďalších odpovedí bolo tam dať proste silné železo, no&nbsp;to zas treba vysúťažiť…<p>Tak som sa začal zamýšľať, ako navrhnúť architektúru niečoho ako systém na&nbsp;objednávanie na&nbsp;testy alebo&nbsp;očkovanie tak, aby&nbsp;som neodovzdával citlivé dáta tretej strane a&nbsp;vystačil si s&nbsp;klasickými servermi.<h2 id=navrh>Návrh</h2><p>Prvé čo&nbsp;treba povedať je, že&nbsp;samotný proces registrácie treba navrhnúť tak, aby&nbsp;sa procesy, ktoré sú úzke hrdlo vyčlenili na&nbsp;asynchrónne spracovanie (tu to bolo napríklad odosielanie SMS).<p>Ďalšia kritická oblasť je rezervácia termínu. Pri&nbsp;veľkej záťaži a&nbsp;použití klasickej relačnej databázy by dochádzalo k&nbsp;degradácii výkonu kvôli zámkom nad riadkami tabuľky. No&nbsp;tu klasická cache nepomôže. Ako riešenie ma napadlo použiť <a href="https://docs.microsoft.com/en-us/sql/relational-databases/in-memory-oltp/in-memory-oltp-in-memory-optimization?view=sql-server-ver15">In-Memory OLTP v&nbsp;MS SQL</a>.<p>V niektorých prípadoch je vhodné si napísať vlastnú in-memory databázu (tak svoje problémy vyriešilo napríklad <em>Kiwi.com</em> - <a href="https://www.youtube.com/watch?v=lbDp8rd9gzU">https://www.youtube.com/watch?v=lbDp8rd9gzU</a>). Pri&nbsp;hľadaní riešenia som narazil na&nbsp;niekoľko databázových enginov napísaných v&nbsp;jazyku <em>Rust</em>. Proste sa zobral protokol pre&nbsp;Redis a&nbsp;k nemu sa doplnila databázová časť. Na&nbsp;niečo takúto sa Rust hodí, lebo&nbsp;už kompilátor jazyk a&nbsp;zabezpečuje pamäťovú bezpečnosť a&nbsp;thread-safe (nemá garbage collector). Odporúčam sa na&nbsp;tento jazyk pozrieť. (Napríklad <a href=https://github.com/mambisi/escanor>escanor</a>, <a href=https://github.com/meilisearch/MeiliES>MeiliES</a>,…).<p>Na nasledujúcom diagrame je znázornená architektúra navrhovaného riešenia.<p><img src=images/InMemoryOltp/Architecture.png class=img-center alt="Architektúra riešenia."><p>Registračná aplikácia bude <em>SPA</em> aplikácia (alebo <em>JAM stack</em>), tak aby&nbsp;bolo možné hostovať frondend ako statické súbory na&nbsp;CDN-ku alebo&nbsp;nezávislom serveri. Pričom je dôležité, aby&nbsp;klientska aplikácia korektne spracovávala http status <em>429 Too Many Requests</em> retry logikou.<p>Nasleduje load balancer (napríklad <a href=https://en.wikipedia.org/wiki/HAProxy>HAProxy</a>), ktorý&nbsp;rozdeľuje requesty na&nbsp;jednotlivé aplikačné inštancie Web API aplikácií, takisto stráži rate limit aby&nbsp;nedošlo k&nbsp;preťaženiu Web API inštancií a&nbsp;korektne vracať http status <em>429</em>. (Poprípade je možné <em>HAProxy</em> doplniť o&nbsp;<a href=https://learn.hashicorp.com/tutorials/consul/load-balancing-haproxy>Consul</a>.)<p>Inštancie Web API slúžia na&nbsp;spracovanie registrácií a&nbsp;obsahujú aplikačnú logiku (v mojom prípade ASP.NET 5.0).<p>Databáza (MS SQL 2019) do&nbsp;ktorej sa ukladajú registrácie. Pričom tabuľka pre&nbsp;uloženie termínu je duplikovaná na&nbsp;dve – klasická tabuľka a&nbsp;in-memory tabuľka (netrpí problémami so&nbsp;zamykaním riadkov v&nbsp;tabuľke), kde&nbsp;sú údaje o&nbsp;registrácii pre&nbsp;najvyťaženejšie obdobie (povedzme registrácie na&nbsp;najbližších 30 dni). Tieto dáta sa synchronizujú v&nbsp;pravidelných intervaloch pomocou stored procedúr, ktoré volá aplikácia <em>Sheduler App</em>. In-memory tabuľka v&nbsp;režime <em>SCHEMA_AND_DATA</em> ukladá zmeny aj&nbsp;na disk, takže v&nbsp;prípade výpadku serveru nedôjde k&nbsp;ich strate.<p>A samozrejme nejaké fronta úloh, napríklad pre&nbsp;odosielanie SMS, ktorá môže byť realizovaná rôznymi spôsobmi (od ukladania v&nbsp;inej databáze, cez RabbitMQ až po&nbsp;exotickejšie riešenia – <a href=https://github.com/microsoft/FASTER>FASTER</a>).<p>Čo sa týka samotnej rezervácie termínu, tak by šla vyriešiť tak, že&nbsp;sa naraz odošlú všetky údaje potrebné údaje, v&nbsp;in-memory tabuľke sa zaregistruje termín, ostatné dáta sa odložia do&nbsp;fronty a&nbsp;spracujú sa neskôr.<h2 id=realizacia>Realizácia</h2><p>Rozhodol som sa, že&nbsp;si skúsim implementovať časť systému, ktorá sa stará o&nbsp;rezerváciu termínu na&nbsp;test, aby&nbsp;som porovnal priamočiaru implementáciu, ktorú si človek zvolí, keď&nbsp;rieši bežný systém, voči implementácii s&nbsp;In-Memory OLTP tabuľkou. Zameral som sa hlavne na&nbsp;databázovú časť, preto aplikačná logika zostala bez&nbsp;optimalizácií.<p>Aplikačný server je Web API realizované pomocou <em>ASP.NET 5.0</em>. Aplikačná logika je implementovaná pomocou <em>Entity Framewrk Core 5.0</em> a&nbsp;v prípade In-Memory OLTP tabuľky je volaná jednoduchá stored procedúra cez SQL klienta, implementácia je priamo v&nbsp;kontroleroch. Inak je použitá defaultná šablóna pre&nbsp;vytvorenie projektu, takže neboli robené žiadne iné optimalizácie na&nbsp;strane aplikácie. A&nbsp;na Web API boli vyvedené ešte&nbsp;metódy na&nbsp;generovanie testovacích dát (knižnicou <a href=https://github.com/bchavez/Bogus>Bogus</a>).<p>Databáza je MS SQL 2019.<p>Systém si do&nbsp;databázy predgeneruje termíny na&nbsp;registráciu (karteziánsky súčin medzi odberovými/očkovacími miestami, dátumom a&nbsp;časom v&nbsp;rámci dňa).<p>DDL pre&nbsp;registračnú in-memory tabuľku vyzerá takto:<pre><code class="language-sql hljs"><span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>TABLE</span> [dbo].[RegistrationInMemory]
(
	[<span class=hljs-keyword>Day</span>] [DATETIME2](<span class=hljs-number>7</span>) <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[TimeSlotId] [<span class=hljs-built_in>INT</span>] <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[PlaceId] [<span class=hljs-built_in>INT</span>] <span class=hljs-keyword>NOT</span> <span class=hljs-literal>NULL</span>,
	[CovidClientId] [<span class=hljs-built_in>INT</span>] <span class=hljs-literal>NULL</span>,
	[<span class=hljs-keyword>Register</span>] [DATETIME2](<span class=hljs-number>7</span>) <span class=hljs-literal>NULL</span>,

    <span class=hljs-keyword>CONSTRAINT</span> [PK_RegistrationInMemory] PRIMARY <span class=hljs-keyword>KEY</span> NONCLUSTERED 
    (
    	[<span class=hljs-keyword>Day</span>] <span class=hljs-keyword>ASC</span>,
    	[TimeSlotId] <span class=hljs-keyword>ASC</span>,
    	[PlaceId] <span class=hljs-keyword>ASC</span>
    ),
    <span class=hljs-keyword>INDEX</span> [RegistrationInMemory_Sorting_IX] NONCLUSTERED 
    (
    	[<span class=hljs-keyword>Day</span>] <span class=hljs-keyword>ASC</span>,
    	[TimeSlotId] <span class=hljs-keyword>ASC</span>,
    	[PlaceId] <span class=hljs-keyword>ASC</span>
    )
) <span class=hljs-keyword>WITH</span> (MEMORY_OPTIMIZED = <span class=hljs-keyword>ON</span>, DURABILITY = SCHEMA_AND_DATA);
</code></pre><p>Primárny kľúč tvorí kombinácia dátumu, času v&nbsp;rámci dňa a&nbsp;odberového/očkovacieho miesta, pre&nbsp;rýchle vyhľadanie pri&nbsp;registrácii.<p>Ďalší index slúži pri&nbsp;vyhľadávaní voľných termínov a&nbsp;ich zobrazení v&nbsp;rámci dňa alebo&nbsp;týždňa.<p>Natívne kompilovaná stored procedúra pre&nbsp;registráciu termínu vyzerá nasledovne:<pre><code class="language-sql hljs"><span class=hljs-keyword>CREATE</span> <span class=hljs-keyword>PROCEDURE</span> [dbo].[RegistrationInMemory_TryRegister]
	@<span class=hljs-built_in>date</span> DATETIME2,
	@slotId <span class=hljs-built_in>INT</span>,
	@placeId <span class=hljs-built_in>INT</span>,
	@covidClientId <span class=hljs-built_in>INT</span>
<span class=hljs-keyword>WITH</span> NATIVE_COMPILATION, SCHEMABINDING
<span class=hljs-keyword>AS</span> <span class=hljs-keyword>BEGIN</span> ATOMIC <span class=hljs-keyword>WITH</span>
(
 <span class=hljs-keyword>TRANSACTION</span> <span class=hljs-keyword>ISOLATION</span> <span class=hljs-keyword>LEVEL</span> = <span class=hljs-keyword>SNAPSHOT</span>, <span class=hljs-keyword>LANGUAGE</span> = N<span class=hljs-string>'us_english'</span>
)
  
  <span class=hljs-keyword>DECLARE</span> @isRegistered <span class=hljs-built_in>BIT</span> = <span class=hljs-number>0</span>;

  <span class=hljs-keyword>UPDATE</span> [dbo].[RegistrationInMemory]
      <span class=hljs-keyword>SET</span> @isRegistered = <span class=hljs-number>1</span>,
          [CovidClientId] = @covidClientId,
          [<span class=hljs-keyword>Register</span>] = <span class=hljs-keyword>GETDATE</span>()
      <span class=hljs-keyword>WHERE</span> [<span class=hljs-keyword>Day</span>] = @<span class=hljs-built_in>date</span> <span class=hljs-keyword>AND</span> [TimeSlotId] = @slotId <span class=hljs-keyword>AND</span> [PlaceId] = @placeId <span class=hljs-keyword>AND</span> [CovidClientId] <span class=hljs-keyword>IS</span> <span class=hljs-literal>NULL</span>;

  <span class=hljs-keyword>SELECT</span> @isRegistered <span class=hljs-keyword>AS</span> [RegistrationSuccessfull];
<span class=hljs-keyword>END</span>
</code></pre><p>Vo výsledku vráti, či&nbsp;sa podarilo používateľa registrovať na&nbsp;zvolený termín.<p>Výhody použitia In-Memory OLTP voči napríklad Redisu sú hlavne v&nbsp;tranzakčnosti presúvania dát do&nbsp;klasických tabuliek, možnosť písať natívne kompilované procedúry a&nbsp;dodatočné indexy (v Redise by ich bolo nutné implementovať aplikačne).<h2 id=vysledky>Výsledky</h2><p>Záťažové testovanie som robil na&nbsp;notebooku s&nbsp;procesorom <em>Inter Core i7-8550U 1.80GHz</em>, <em>8GB</em> RAM a&nbsp;SSD diskom na&nbsp;operačnom systéme <em>Windows 10 Pro verzia 2004</em>.<p>Použil som naň nástroj <a href=https://github.com/hallatore/Netling>Netling</a> a&nbsp;testovacie GET metódy kontroleru vyberali náhodné termíny na&nbsp;náhodných miestach pre&nbsp;registráciu.<p>Zaujímavé zistenie bolo, že&nbsp;v in-memory tabuľke dáta aj&nbsp;s indexami pre&nbsp;5&nbsp;000&nbsp;000 termínov na&nbsp;registráciu zaberali približne 1GB z&nbsp;RAM.<p>Pri klasickom použití tabuľky a&nbsp;Entity Frameworku (načítanie termínu a&nbsp;jeho modifikácia) som sa dostal na&nbsp;priepustnosť 1&nbsp;386 requestov za&nbsp;sekundu. (Snímka okna nižšie.)<p><img src=images/InMemoryOltp/SqlTable.png class=img-center alt="Výsledky použitia klasickej tabuľky."><p>Pri použití In-Memory tabuľky volanej cez SQL klienta som sa dostal na&nbsp;priepustnosť 10&nbsp;069 requestov za&nbsp;sekundu. Čo&nbsp;už je slušné číslo na&nbsp;aplikáciu bez&nbsp;akýchkoľvek optimalizácií. Pri&nbsp;in-memory tabuľke bolo úzke hrdlo procesor. (Snímka okna nižšie.)<p><img src=images/InMemoryOltp/InMemorytable.png class=img-center alt="Výsledky použitia klasickej tabuľky."><p><strong>Poznámky</strong>: Rozdiel v&nbsp;rýchlosti medzi <em>Entity Frameowrkom Core 5</em> a&nbsp;priamom prístupom (SQL klient) je zanedbateľný. Vysoké čísla a&nbsp;nízku latenciu považujem za&nbsp;výsledok toho, že&nbsp;som testoval na&nbsp;rovnakom notebooku ako bežal server a&nbsp;teda odpadáva sieťová latencia. Relatívne malý bandwidth je spôsobený testovaním pomocou NETLING-u, využíva len GET požiadavky.<h2 id=zaver>Záver</h2><p>Dlho som hľadal nejaký reálny use-case pre&nbsp;technológiu In-Memory OLTP, konečne sa mi ju podarilo vyskúšať. Dosť príjemne ma prekvapili čísla performace aj&nbsp;množstvo zabranej pamäte. <strong>Desaťtisíc spracovaných requestov za&nbsp;sekundu som nečakal.</strong><p>No musím podotknúť, že&nbsp;som prakticky riešil len malú časť systému a&nbsp;taktiež môj experiment ignoruje sieťovú latenciu. Takže vo výsledku by na&nbsp;strane aplikácie tých requetsov bolo spracovaných menej.<p>Do pozornosti ešte&nbsp;dávam prednášku o&nbsp;tom, ako spracovávať Big Data v&nbsp;MS SQL - <a href=https://wug.cz/zaznamy/503-SQL-Server-Bootcamp-2018-Zpracovavejte-velka-data-v-SQL-Serveru-rychlosti-blesku>https://wug.cz/zaznamy/503-SQL-Server-Bootcamp-2018-Zpracovavejte-velka-data-v-SQL-Serveru-rychlosti-blesku</a> a&nbsp;architektúru <a href=https://docs.microsoft.com/en-us/azure/architecture/patterns/cqrs>CQRS</a>.</div><div class="col-lg-4 col-md-4 hidden-xs hidden-sm"><div class=well><h4>Vývoj</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/InMemoryOltp.html>Experiment s In-Memory OLTP</a><li><a href=/CoMaNauciloIot.html>Čo ma naučilo IoT</a><li><a href=/SkEid.html>eID nie je platobná karta</a><li><a href=/eVolby.html>Elektronické voľby</a><li><a href=/Blazor.html>Ako ma zachránil Blazor</a><li><a href=/NetCoreSecuring.html>Dodatočné zabezpečenie .Net Core</a><li><a href=/SlovakWyamTypography.html>Slovenská typografia pre wyam</a><li><a href=/HostCoreInDll.html>CoreCrl v natívnej DLL knižnici</a><li><a href=/SkEidSign.html>Podpisovanie PDF v .Net Core</a><li><a href=/Ansible.html>Ansible a .Net Core</a><li><a href=/DevelopingAll.html>…</a></ul></div></div></div><div class=well><h4>Všeobecné</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/EzoGenerator.html>Generátor Ezo textov</a><li><a href=/AlternativnyRecept.html>Propagácia alternatívnej medicíny</a><li><a href=/VotrelciDavnoveku.html>Votrelci dávnoveku</a><li><a href=/GeneralAll.html>…</a></ul></div></div></div><div class=well><h4>O mne</h4><div class=row><div class=col-lg-12><ul class=list-unstyled><li><a href=/OMne.html>O mne</a><li><a href=/OMneOdkazy.html>Moja tvorba inde</a><li><a href=/Portfolio.html>Portólio</a></ul></div></div></div></div></div><hr><footer><div class=row><div class="col-lg-8 col-sm-8"><div class=well><h4>Našli ste chybu, alebo chcete niečo doplniť?</h4><p>Ak ste našli chybu v článu, chcete niečo dopniť, alebo sa vyjadriť k téme, môžete na <a href="https://github.com/harrison314/harrison314.github.io/issues/new?title=Experiment%20s%20In-Memory%20OLTP&amp;body=https%3A%2F%2Fharrison314.github.io%2FInMemoryOltp.html" target=_blank>Githube otvoriť issue</a>.</div></div></div><div class=row><div class=col-lg-12><p>Copyright © harrison314 2013</div></div></footer></div><script src=js/jquery.js></script><script src=js/bootstrap.min.js></script>